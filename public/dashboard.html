<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BLOCKSCOM | Premium AI SAAS</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
    rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root {
      --bg: #09090b;
      --surface: #121216;
      --surface-elevated: #1c1c21;
      --border: #27272a;
      --primary: #ffffff;
      --accent: #3f3f46;
      --success: #22c55e;
      --danger: #ef4444;
      --warning: #f59e0b;
      --text: #fafafa;
      --text-muted: #a1a1aa;
      --text-dim: #71717a;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
    }

    /* Layout */
    .sidebar {
      width: 280px;
      border-right: 1px solid var(--border);
      padding: 32px 24px;
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      background: var(--bg);
      z-index: 50;
      transition: transform 0.3s ease;
    }

    .main {
      flex: 1;
      margin-left: 280px;
      padding: 48px;
      max-width: 1300px;
      width: 100%;
    }

    /* Mobile Layout Overrides */
    @media (max-width: 900px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main {
        margin-left: 0;
        padding: 80px 24px 24px 24px;
        /* Room for mobile header */
      }
    }

    /* Typography */
    .logo {
      font-weight: 800;
      font-size: 1.25rem;
      margin-bottom: 48px;
      letter-spacing: -0.5px;
    }

    .logo span {
      color: var(--text-dim);
      margin-left: 2px;
    }

    h1 {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    h2 {
      font-size: 1.25rem;
      font-weight: 600;
    }

    h3 {
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-dim);
      letter-spacing: 0.5px;
    }

    /* Navigation */
    .nav-group {
      margin-bottom: 32px;
    }

    .nav-label {
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
      padding-left: 12px;
    }

    .nav-item {
      padding: 12px 16px;
      border-radius: 10px;
      color: var(--text-muted);
      cursor: pointer;
      transition: 0.2s;
      font-size: 0.9rem;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .nav-item:hover {
      background: var(--surface);
      color: var(--text);
    }

    .nav-item.active {
      background: var(--surface-elevated);
      color: var(--primary);
      font-weight: 600;
    }

    .user-card {
      margin-top: auto;
      padding: 16px;
      background: linear-gradient(145deg, var(--surface), var(--surface-elevated));
      border: 1px solid var(--border);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .user-profile-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      border: 1px solid var(--border);
      flex-shrink: 0;
    }

    .user-info {
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .user-email {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-tier {
      font-size: 0.65rem;
      font-weight: 800;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 2px;
    }

    .user-credits-container {
      background: var(--bg);
      border-radius: 10px;
      padding: 10px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid var(--border);
    }

    .credits-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-dim);
      text-transform: uppercase;
    }

    .credits-amount {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--success);
    }

    .btn-logout {
      width: 100%;
      background: transparent;
      border: 1px dashed var(--border);
      color: var(--text-muted);
      padding: 10px;
      border-radius: 10px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: 0.2s;
    }

    .btn-logout:hover {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border-color: rgba(239, 68, 68, 0.3);
    }

    /* Components */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 28px;
      margin-bottom: 24px;
      transition: 0.2s;
    }

    .card:hover {
      border-color: var(--accent);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(min(360px, 100%), 1fr));
      gap: 24px;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      font-size: 0.85rem;
      transition: 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary);
      color: var(--bg);
    }

    .btn-primary:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--surface-elevated);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--accent);
    }

    .btn-danger {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }

    .btn-danger:hover {
      background: var(--danger);
      color: white;
    }

    .input {
      width: 100%;
      padding: 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      margin-top: 8px;
      margin-bottom: 20px;
      font-size: 0.9rem;
      transition: 0.2s;
    }

    .input:focus {
      outline: none;
      border-color: var(--text-dim);
    }

    textarea.input {
      min-height: 240px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: 800;
      text-transform: uppercase;
    }

    .badge-premium {
      background: linear-gradient(135deg, #f59e0b, #ea580c);
      color: white;
    }

    .badge-free {
      background: var(--accent);
      color: var(--text-muted);
    }

    /* Modals */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--surface);
      width: 100%;
      max-width: 650px;
      padding: 40px;
      border-radius: 24px;
      border: 1px solid var(--border);
      max-height: 90vh;
      overflow-y: auto;
    }

    @media (max-width: 600px) {
      .modal {
        padding: 20px;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      .card {
        padding: 20px;
        border-radius: 16px;
      }
    }

    /* Mobile automation card fixes */
    @media (max-width: 480px) {
      .main {
        padding: 72px 12px 16px 12px;
      }

      h1 {
        font-size: 1.4rem;
      }

      .card {
        padding: 16px;
        border-radius: 14px;
        margin-bottom: 16px;
      }

      .grid {
        gap: 16px;
      }
    }

    .kb-selection-container {
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--bg);
      overflow: hidden;
    }

    .kb-search-bar {
      width: 100%;
      padding: 12px 16px;
      background: var(--surface);
      border: none;
      border-bottom: 1px solid var(--border);
      color: var(--text);
      font-size: 0.85rem;
      outline: none;
    }

    .kb-selection-list {
      max-height: 200px;
      overflow-y: auto;
      padding: 8px;
    }

    .kb-checkbox {
      padding: 8px 12px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: 0.2s;
    }

    .kb-checkbox:hover {
      background: var(--surface-elevated);
    }

    .kb-checkbox input {
      accent-color: var(--primary);
    }

    /* Tables */
    .table-responsive {
      width: 100%;
      overflow-x: auto;
      background: var(--surface);
      border-radius: 20px;
      border: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }

    th {
      text-align: left;
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--text-dim);
      text-transform: uppercase;
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    td {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      font-size: 0.85rem;
    }

    .empty-state {
      text-align: center;
      padding: 64px 24px;
      color: var(--text-dim);
    }

    /* Mobile Header */
    .mobile-header {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      z-index: 40;
      padding: 0 24px;
      align-items: center;
      justify-content: space-between;
    }

    .hamburger {
      background: transparent;
      border: none;
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
    }

    @media (max-width: 900px) {
      .mobile-header {
        display: flex;
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }

      .header .btn {
        width: 100%;
      }

      .header>div:last-child {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
    }

    @media (max-width: 480px) {
      .mobile-header {
        padding: 0 12px;
      }
    }

    /* Template Picker */
    .template-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-top: 20px;
    }

    .template-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px 16px;
      cursor: pointer;
      transition: all 0.25s ease;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .template-card:hover {
      border-color: var(--primary);
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(255, 255, 255, 0.04);
    }

    .template-icon {
      font-size: 1.8rem;
    }

    .template-label {
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--text);
      line-height: 1.3;
    }

    .template-desc {
      font-size: 0.7rem;
      color: var(--text-dim);
    }

    /* Add to Page Popup */
    .atp-popup {
      position: absolute;
      bottom: calc(100% + 8px);
      right: 0;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      min-width: 220px;
      max-height: 260px;
      overflow-y: auto;
      z-index: 100;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      display: none;
    }

    .atp-popup.active {
      display: block;
    }

    .atp-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: 0.15s;
    }

    .atp-item:hover {
      background: var(--bg);
    }

    .atp-item input {
      accent-color: var(--primary);
    }

    .atp-title {
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--text-dim);
      text-transform: uppercase;
      padding: 0 8px 6px 8px;
      margin-bottom: 4px;
      border-bottom: 1px solid var(--border);
    }

    @keyframes pulse-dot {

      0%,
      100% {
        opacity: 1;
        transform: scale(1);
      }

      50% {
        opacity: 0.5;
        transform: scale(0.8);
      }
    }

    .admin-log-new {
      animation: flash-row 1s ease-out;
    }

    @keyframes flash-row {
      from {
        background: rgba(34, 197, 94, 0.15);
      }

      to {
        background: transparent;
      }
    }
  </style>
  <link rel="icon" href="data:,">
</head>

<body>
  <div class="sidebar">
    <div class="logo">BLOCKSCOM<span>‚óè</span></div>

    <div class="nav-group">
      <div class="nav-label">Main</div>
      <div class="nav-item active" id="nav-pages" onclick="showView('pages')">Dashboard</div>
      <div class="nav-item" id="nav-kb" onclick="showView('kb')">Knowledge Base</div>
      <div class="nav-item" id="nav-products" onclick="showView('products')">Inventory System</div>
      <div class="nav-item" id="nav-images" onclick="showView('images')">Images</div>
      <div class="nav-item" id="nav-logs" onclick="showView('logs')">Live Activity</div>
      <div class="nav-item" onclick="window.location.href='/orders.html'">Orders</div>
    </div>

    <div class="nav-group">
      <div class="nav-label">Settings</div>
      <div class="nav-item" id="nav-settings" onclick="showView('settings')">Platform Settings</div>
      <div id="admin-nav" class="nav-item" style="display:none" onclick="showView('admin')">Admin Controls</div>
      <div id="admin-logs-nav" class="nav-item" style="display:none" onclick="showView('admin-logs')">Admin Logs</div>
    </div>

    <div class="user-card">
      <div class="user-profile-row">
        <div class="user-avatar">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </div>
        <div class="user-info">
          <div id="u-email" class="user-email">...</div>
          <div id="u-tier" class="user-tier">FREE TIER</div>
        </div>
      </div>
      <div class="user-credits-container">
        <div class="credits-label">Balance</div>
        <div id="u-credits" class="credits-amount">0 Credits</div>
      </div>
      <div style="font-size:0.65rem; color:var(--text-dim); text-align:center; margin-top:6px; opacity:0.7">1 reply = 1
        credit</div>
      <button onclick="logout()" class="btn-logout">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
        Sign Out
      </button>
    </div>
  </div>

  <div class="mobile-header">
    <div class="logo" style="margin-bottom:0; font-size:1.1rem">BLOCKSCOM<span>‚óè</span></div>
    <button class="hamburger" onclick="toggleSidebar()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>
  </div>

  <main class="main">
    <!-- View: Pages -->
    <div id="view-pages" class="view-section">
      <div class="header">
        <div>
          <h1>My Automations</h1>
          <p style="color:var(--text-dim); font-size:0.9rem; margin-top:4px">Manage your Facebook Page webhooks.</p>
        </div>
        <button class="btn btn-primary" onclick="openPageModal()">+ Add Automation</button>
      </div>
      <div id="pages-list" class="grid"></div>
    </div>

    <!-- View: KB -->
    <div id="view-kb" class="view-section" style="display:none">
      <div class="header">
        <div>
          <h1>Knowledge Base</h1>
          <p style="color:var(--text-dim); font-size:0.9rem; margin-top:4px">Add skills and context for your AI models.
          </p>
        </div>
        <div style="display:flex; gap:12px; align-items:center">
          <button class="btn btn-secondary" onclick="exportKbMd()">‚≠≥ Export .md</button>
          <button class="btn btn-secondary" onclick="document.getElementById('kb-import-file').click()">‚ü≥ Import
            .md</button>
          <input type="file" id="kb-import-file" style="display:none" accept=".md,.txt" multiple
            onchange="importKbFiles(event)">
          <button class="btn btn-primary" onclick="openTemplatePicker()">+ Add New Skill</button>
        </div>
      </div>
      <div id="kb-list" class="grid"></div>
    </div>

    <!-- View: Inventory (Flexible Spreadsheets) -->
    <div id="view-products" class="view-section" style="display:none">
      <!-- Table List -->
      <div id="inv-list-view">
        <div class="header">
          <div>
            <h1>Inventory System</h1>
            <p style="color:var(--text-dim); font-size:0.9rem; margin-top:4px">Create custom spreadsheets to organize
              your products and inventory. Each auto-syncs to your AI knowledge base.</p>
          </div>
          <div style="display:flex; gap:12px; align-items:center">
            <div style="position:relative; display:inline-block" id="inv-template-dropdown">
              <button class="btn btn-secondary"
                onclick="document.getElementById('inv-template-menu').style.display = document.getElementById('inv-template-menu').style.display === 'block' ? 'none' : 'block'">üìã
                Use Template ‚ñæ</button>
              <div id="inv-template-menu"
                style="display:none; position:absolute; top:100%; right:0; margin-top:6px; background:var(--surface-elevated); border:1px solid var(--border); border-radius:12px; min-width:240px; z-index:100; box-shadow:0 8px 24px rgba(0,0,0,0.3); overflow:hidden">
                <div
                  style="padding:12px 16px; border-bottom:1px solid var(--border); font-size:0.75rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:0.5px">
                  Choose a Template</div>
                <div onclick="openInvFromTemplate('products')"
                  style="padding:12px 16px; cursor:pointer; transition:background 0.15s"
                  onmouseover="this.style.background='var(--surface)'" onmouseout="this.style.background='transparent'">
                  <div style="font-weight:600; font-size:0.9rem">üõçÔ∏è Products</div>
                  <div style="font-size:0.75rem; color:var(--text-dim); margin-top:2px">Name, Price, Stock, Category,
                    Description</div>
                </div>
                <div onclick="openInvFromTemplate('food')"
                  style="padding:12px 16px; cursor:pointer; transition:background 0.15s"
                  onmouseover="this.style.background='var(--surface)'" onmouseout="this.style.background='transparent'">
                  <div style="font-weight:600; font-size:0.9rem">üçî Food Menu</div>
                  <div style="font-size:0.75rem; color:var(--text-dim); margin-top:2px">Item, Price, Category,
                    Available, Description</div>
                </div>
                <div onclick="openInvFromTemplate('appointments')"
                  style="padding:12px 16px; cursor:pointer; transition:background 0.15s; border-radius:0 0 12px 12px"
                  onmouseover="this.style.background='var(--surface)'" onmouseout="this.style.background='transparent'">
                  <div style="font-weight:600; font-size:0.9rem">üìÖ Appointments</div>
                  <div style="font-size:0.75rem; color:var(--text-dim); margin-top:2px">Service, Duration, Price,
                    Available, Notes</div>
                </div>
              </div>
            </div>
            <button class="btn btn-primary" onclick="openInvTableModal()">+ New Spreadsheet</button>
          </div>
        </div>
        <div id="inv-tables-list" class="grid"></div>
      </div>
      <!-- Table Detail / Spreadsheet Edit -->
      <div id="inv-detail-view" style="display:none">
        <div class="header">
          <div style="display:flex; align-items:center; gap:12px">
            <button class="btn btn-secondary" onclick="closeInvDetail()" style="padding:8px 12px">‚Üê Back</button>
            <div>
              <h1 id="inv-detail-title">Spreadsheet</h1>
              <p style="color:var(--text-dim); font-size:0.8rem; margin-top:2px" id="inv-detail-kb-link">Auto-synced to
                KB</p>
            </div>
          </div>
          <div style="display:flex; gap:12px; align-items:center">
            <button class="btn btn-secondary" onclick="exportInvCSV()">‚≠≥ Export CSV</button>
            <button class="btn btn-secondary" onclick="document.getElementById('inv-import-file').click()">‚ü≥
              Import</button>
            <input type="file" id="inv-import-file" style="display:none" accept=".txt,.csv"
              onchange="importInvFile(event)">
            <button class="btn btn-primary" onclick="addInvRow()">+ Add Row</button>
          </div>
        </div>
        <div class="card" style="padding:0; overflow:hidden">
          <div class="table-responsive">
            <table style="margin:0">
              <thead id="inv-detail-thead"></thead>
              <tbody id="inv-detail-tbody"></tbody>
            </table>
          </div>
        </div>
        <div style="margin-top:16px; display:flex; gap:12px">
          <button class="btn btn-primary" onclick="saveInvRows()">üíæ Save All Changes</button>
          <button class="btn btn-secondary" onclick="syncInvTable()">‚ü≥ Force Sync to KB</button>
        </div>
      </div>
    </div>

    <!-- View: Images -->
    <div id="view-images" class="view-section" style="display:none">
      <div class="header">
        <div>
          <h1>Images</h1>
          <p style="color:var(--text-dim); font-size:0.9rem; margin-top:4px">Upload and manage your images. Create
            trigger photos for your AI.</p>
        </div>
        <div style="display:flex; gap:12px; align-items:center">
          <div id="img-usage-badge"
            style="background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:8px 14px; font-size:0.75rem; font-weight:700; color:var(--text-muted)">
            0 / 3</div>
          <button class="btn btn-primary" onclick="openUploadModal()">+ Upload Image</button>
        </div>
      </div>

      <!-- Image Gallery -->
      <div id="images-gallery"
        style="display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:16px; margin-bottom:40px">
      </div>

      <!-- Trigger Photos Section -->
      <div style="margin-top:16px">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
          <div>
            <h2>Trigger Photos</h2>
            <p style="color:var(--text-dim); font-size:0.85rem; margin-top:4px">Set up images that auto-send when users
              say specific words or phrases.</p>
          </div>
          <button class="btn btn-secondary" onclick="openTriggerPhotoModal()">+ Create Trigger Photo</button>
        </div>
        <div id="trigger-photos-list"></div>
      </div>
    </div>

    <!-- View: Activity Logs -->
    <div id="view-logs" class="view-section" style="display:none">
      <div class="header" style="display:flex; justify-content:space-between; align-items:center;">
        <h1>System Activity</h1>
        <div style="display:flex; gap:12px;">
          <button class="btn btn-secondary" onclick="exportLogsCSV()">‚≠≥ Export Live Data (CSV)</button>
          <button class="btn btn-primary" onclick="analyzeLogs()">‚ú® ANALYZE CHATLOGS (PDF) - 2 Credits</button>
        </div>
      </div>
      <div class="card" style="padding:0; overflow:hidden">
        <div class="table-responsive">
          <table style="margin:0">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Source Page</th>
                <th>Type</th>
                <th>Payload Detail</th>
              </tr>
            </thead>
            <tbody id="logs-table"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- View: Admin -->
    <div id="view-admin" class="view-section" style="display:none">
      <div class="header">
        <h1>SaaS Administration</h1>
      </div>
      <div class="card" style="padding:0; overflow:hidden">
        <div class="table-responsive">
          <table style="margin:0">
            <thead>
              <tr>
                <th>User Entity</th>
                <th>System Role</th>
                <th>Credits Balance</th>
                <th>Management</th>
              </tr>
            </thead>
            <tbody id="admin-users"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- View: Admin Logs -->
    <div id="view-admin-logs" class="view-section" style="display:none">
      <div class="header">
        <div>
          <h1>Admin Logs</h1>
          <p style="color:var(--text-dim); font-size:0.9rem; margin-top:4px">Live system activity across all users &
            webhooks.</p>
        </div>
        <div style="display:flex; gap:8px">
          <button class="btn btn-secondary" onclick="loadAdminLogs()" style="padding:8px 16px">‚Üª Refresh</button>
          <div
            style="display:flex; align-items:center; gap:6px; background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:8px 12px;">
            <div id="admin-live-dot"
              style="width:8px; height:8px; border-radius:50%; background:#22c55e; animation: pulse-dot 2s infinite;">
            </div>
            <span
              style="font-size:0.75rem; color:var(--text-dim); font-weight:600; text-transform:uppercase">Live</span>
          </div>
        </div>
      </div>

      <!-- Webhook Status Overview -->
      <div class="card" style="margin-bottom:24px">
        <h2 style="margin-bottom:16px">Webhook Status Overview</h2>
        <div class="table-responsive">
          <table style="margin:0">
            <thead>
              <tr>
                <th>Page Name</th>
                <th>Owner</th>
                <th>AI Model</th>
                <th>Status</th>
                <th>Credits</th>
              </tr>
            </thead>
            <tbody id="admin-pages-table"></tbody>
          </table>
        </div>
      </div>

      <!-- Live Activity Feed -->
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
          <h2>Activity Feed</h2>
          <div style="font-size:0.75rem; color:var(--text-dim)" id="admin-log-count">0 events</div>
        </div>
        <div class="table-responsive" style="max-height:600px; overflow-y:auto">
          <table style="margin:0">
            <thead style="position:sticky; top:0; z-index:1; background:var(--surface)">
              <tr>
                <th style="white-space:nowrap">Time</th>
                <th>Page</th>
                <th>Owner</th>
                <th>Type</th>
                <th style="max-width:500px">Message</th>
              </tr>
            </thead>
            <tbody id="admin-logs-table"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- View: Settings -->
    <div id="view-settings" class="view-section" style="display:none">
      <div class="header">
        <h1>Platform Settings</h1>
      </div>
      <div class="grid">
        <div class="card">
          <h2>Store Defaults</h2>
          <p style="font-size:0.85rem; color:var(--text-dim); margin-top:8px">Set your primary currency for the
            inventory, store, and AI bot responses.</p>
          <div style="margin-top:24px">
            <label>Default Currency (Active)</label>
            <select id="currency-selector" class="input" onchange="updateCurrency()">
              <option value="PHP">PHP (‚Ç±)</option>
              <option value="USD">USD ($)</option>
              <option value="EUR">EUR (‚Ç¨)</option>
              <option value="GBP">GBP (¬£)</option>
              <option value="JPY">JPY (¬•)</option>
            </select>
            <div id="currency-rate-info" style="font-size:0.75rem; color:var(--text-dim); margin-top:12px;">Loading
              rates...</div>
          </div>
        </div>
        <div class="card">
          <h2>Change Password</h2>
          <form onsubmit="event.preventDefault(); updatePassword();" style="margin-top:24px">
            <label>New Secret Password</label>
            <input type="password" id="new-password" class="input" placeholder="Min. 8 characters" required>
            <button type="submit" class="btn btn-primary">Update Account Password</button>
          </form>
        </div>
        <div class="card">
          <h2>Transaction PIN</h2>
          <p style="font-size:0.85rem; color:var(--text-dim); margin-top:8px">Secure your account actions with a 6-digit
            PIN.</p>
          <form onsubmit="event.preventDefault(); updatePin();" style="margin-top:24px">
            <label>Secure PIN</label>
            <input type="password" id="new-pin" class="input" placeholder="XXXXXX" maxlength="6" required>
            <button type="submit" class="btn btn-primary">Set Transaction PIN</button>
          </form>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal: Page -->
  <div class="modal-overlay" id="pageModal">
    <div class="modal">
      <h2 id="pageModalTitle" style="margin-bottom:8px">Webhook Configuration</h2>
      <p style="color:var(--text-dim); font-size:0.85rem; margin-bottom:32px">Configure how AI should handle this
        Facebook Page.
        <a href="/fb-setup-docs.html" target="_blank" style="color:#60a5fa; text-decoration:none;">Don't know how to get
          this information? Read the setup guide.</a>
      </p>
      <div
        style="background:var(--bg); border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:24px; display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div style="display:flex; align-items:center; gap:12px; flex:1; overflow:hidden;">
          <div
            style="display:flex; align-items:center; justify-content:center; width:36px; height:36px; background:var(--surface-elevated); border-radius:8px; color:var(--text-muted); flex-shrink:0;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
          </div>
          <div style="flex:1; overflow:hidden;">
            <div
              style="font-size:0.7rem; font-weight:700; color:var(--text-dim); text-transform:uppercase; margin-bottom:4px">
              Your Webhook URL</div>
            <div id="modal-webhook-link"
              style="font-family:monospace; font-size:0.85rem; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
              Loading...</div>
          </div>
        </div>
        <button type="button" class="btn btn-secondary" style="padding:8px 16px; font-size:0.75rem; flex-shrink:0;"
          onclick="copyWebhookLink(this)">Copy</button>
      </div>
      <form onsubmit="event.preventDefault(); savePage();">
        <input type="hidden" id="p-id-hidden">

        <label>Internal Name</label><input id="p-name" class="input" placeholder="e.g. Main Customer Support" required>
        <label>Widget Chatbot Name</label><input id="p-widget-name" class="input"
          placeholder="e.g. Blockscom Assistant">
        <label>Facebook Page ID (Numeric)</label><input id="p-id" class="input" placeholder="Find this in Page settings"
          required>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px">
          <div><label>Verify Token</label><input id="p-vtok" class="input" type="password"
              placeholder="Your secret phrase">
          </div>
          <div>
            <label>AI Intelligence Model</label>
            <select id="p-model" class="input">
              <option value="arcee-ai/trinity-large-preview:free" data-tier="free">Free Default</option>
              <option value="stepfun/step-3.5-flash:free" data-tier="free">Free Default 2</option>
              <option value="openai/gpt-oss-20b" data-tier="paid">Mid Model 1 (Default)</option>
              <option value="openai/gpt-oss-120b" data-tier="paid">Mid Model 2</option>
              <option value="google/gemini-2.5-flash-lite" data-tier="paid">Flash Light Model</option>
              <option value="google/gemini-3-flash-preview" data-tier="paid">Fast Flash Model</option>
              <option value="openai/gpt-5-nano" data-tier="paid">High Flash Model</option>
            </select>
            <div id="model-restriction-note" style="display:none; font-size:0.7rem; color:#f59e0b; margin-top:4px">‚ö†
              FREE tier can only use Free User models. Upgrade to unlock premium models.</div>
          </div>
        </div>

        <label>Page Access Token</label><input id="p-atok" class="input" type="password" placeholder="EAAb...">

        <div id="personality-picker-section" style="margin-top:12px; display:none">
          <h3>üß† Chatbot Personality</h3>
          <p style="font-size:0.75rem; color:var(--text-dim); margin-top:4px">Choose how your AI chatbot should
            communicate. This sets the default tone for all conversations.</p>
          <div style="display:flex; gap:10px; margin-top:10px; align-items:center">
            <select id="personality-select" class="input" style="flex:1; margin:0">
              <option value="friendly">ü§ù Friendly Assistant ‚Äî Warm, natural, concise</option>
              <option value="professional">üéØ Professional ‚Äî Formal, business-like</option>
              <option value="energetic">üéâ Energetic Seller ‚Äî Upbeat, sales-focused</option>
              <option value="custom">‚úçÔ∏è Custom ‚Äî Write your own</option>
            </select>
            <button type="button" class="btn btn-primary" style="padding:10px 20px; white-space:nowrap"
              onclick="applyPersonalityTemplate()">Set</button>
          </div>
          <div id="personality-status" style="font-size:0.75rem; color:var(--success); margin-top:8px; display:none">
          </div>
        </div>

        <div style="margin-top:12px">
          <h3>Active Knowledge Skills</h3>
          <p style="font-size:0.75rem; color:var(--text-dim); margin-top:4px">Select which skills this AI should use
            when replying.</p>
          <div class="kb-selection-container">
            <input type="text" class="kb-search-bar" placeholder="Search skills..." onkeyup="filterSkills(this.value)">
            <div id="kb-selector-list" class="kb-selection-list"></div>
          </div>
        </div>

        <div style="margin-top:20px">
          <h3>Linked Inventory Spreadsheets</h3>
          <p style="font-size:0.75rem; color:var(--text-dim); margin-top:4px">Select which inventory tables the AI can
            reference on this page.</p>
          <div class="kb-selection-container">
            <div id="inv-table-selector-list" class="kb-selection-list"></div>
          </div>
        </div>

        <div style="display:flex; gap:12px; margin-top:40px">
          <button type="submit" class="btn btn-primary" style="flex:1">Deploy Configuration</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('pageModal')">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: KB -->
  <div class="modal-overlay" id="kbModal">
    <div class="modal">
      <h2 id="kbModalTitle" style="margin-bottom:8px">Skill Development</h2>
      <p style="color:var(--text-dim); font-size:0.85rem; margin-bottom:32px">Add technical documentation or FAQ for the
        AI to ingest.</p>
      <input type="hidden" id="kb-id-hidden">
      <label>Skill Title</label><input id="kb-title" class="input" placeholder="e.g. Return Policy">
      <label>Knowledge Content (.MD / Text)</label><textarea id="kb-content" class="input"
        placeholder="# Policy..."></textarea>
      <div style="display:flex; gap:12px; margin-top:32px">
        <button class="btn btn-primary" style="flex:1" onclick="saveKb()">Save Skill Entry</button>
        <button class="btn btn-secondary" onclick="closeModal('kbModal')">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Modal: Template Picker -->
  <div class="modal-overlay" id="templatePickerModal">
    <div class="modal" style="max-width:700px">
      <h2 style="margin-bottom:8px">Choose a Skill Template</h2>
      <p style="color:var(--text-dim); font-size:0.85rem; margin-bottom:12px">Select a template to get started quickly,
        or create a blank skill from scratch.</p>
      <div
        style="font-size:0.7rem; font-weight:700; color:var(--text-dim); text-transform:uppercase; letter-spacing:0.5px; margin-top:20px; margin-bottom:10px">
        &#11088; Popular Templates</div>
      <div class="template-grid" id="popular-templates">
        <div class="template-card" onclick="selectTemplate('business_general')"
          style="border-color:rgba(59,130,246,0.3); background:linear-gradient(145deg, var(--bg), rgba(59,130,246,0.05))">
          <div class="template-icon">&#127970;</div>
          <div class="template-label">Business</div>
          <div class="template-desc">General business KB</div>
        </div>
        <div class="template-card" onclick="selectTemplate('customer_support')"
          style="border-color:rgba(168,85,247,0.3); background:linear-gradient(145deg, var(--bg), rgba(168,85,247,0.05))">
          <div class="template-icon">&#127911;</div>
          <div class="template-label">Customer Support</div>
          <div class="template-desc">Handle inquiries</div>
        </div>
        <div class="template-card" onclick="selectTemplate('venue')"
          style="border-color:rgba(236,72,153,0.3); background:linear-gradient(145deg, var(--bg), rgba(236,72,153,0.05))">
          <div class="template-icon">&#127963;&#65039;</div>
          <div class="template-label">Venue</div>
          <div class="template-desc">Location &amp; events</div>
        </div>
        <div class="template-card" onclick="selectTemplate('appointment_booking')"
          style="border-color:rgba(34,197,94,0.3); background:linear-gradient(145deg, var(--bg), rgba(34,197,94,0.05))">
          <div class="template-icon">&#128197;</div>
          <div class="template-label">Appointment</div>
          <div class="template-desc">Schedule bookings</div>
        </div>
      </div>
      <div
        style="font-size:0.7rem; font-weight:700; color:var(--text-dim); text-transform:uppercase; letter-spacing:0.5px; margin-top:24px; margin-bottom:10px">
        More Templates</div>
      <div class="template-grid">
        <div class="template-card" onclick="selectTemplate('blank')">
          <div class="template-icon">&#128221;</div>
          <div class="template-label">Blank Skill</div>
          <div class="template-desc">Start from scratch</div>
        </div>
        <div class="template-card" onclick="selectTemplate('order_taking')">
          <div class="template-icon">&#128722;</div>
          <div class="template-label">Order Taking</div>
          <div class="template-desc">Process orders</div>
        </div>
        <div class="template-card" onclick="selectTemplate('returns_refunds')">
          <div class="template-icon">&#128260;</div>
          <div class="template-label">Returns &amp; Refunds</div>
          <div class="template-desc">Handle returns</div>
        </div>
        <div class="template-card" onclick="selectTemplate('upsell_crosssell')">
          <div class="template-icon">&#128176;</div>
          <div class="template-label">Upsell &amp; Cross-sell</div>
          <div class="template-desc">Boost revenue</div>
        </div>
        <div class="template-card" onclick="selectTemplate('faq')">
          <div class="template-icon">&#10067;</div>
          <div class="template-label">FAQ Base</div>
          <div class="template-desc">Common questions</div>
        </div>
      </div>
      <div style="margin-top:24px; text-align:right">
        <button class="btn btn-secondary" onclick="closeModal('templatePickerModal')">Cancel</button>
      </div>
    </div>
  </div>


  <!-- Modal: Template Form -->
  <div class="modal-overlay" id="templateFormModal">
    <div class="modal" style="max-width:650px">
      <h2 id="templateFormTitle" style="margin-bottom:8px">Fill in Template</h2>
      <p id="templateFormDesc" style="color:var(--text-dim); font-size:0.85rem; margin-bottom:24px">Fill in the details
        below. The AI skill content will be auto-generated.</p>
      <div id="templateFormFields"></div>
      <div style="display:flex; gap:12px; margin-top:32px">
        <button class="btn btn-primary" style="flex:1" onclick="saveTemplateForm()">Generate & Save Skill</button>
        <button class="btn btn-secondary" onclick="closeModal('templateFormModal')">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Modal: Inventory Table Create/Edit -->
  <div class="modal-overlay" id="invTableModal">
    <div class="modal">
      <h2 id="invTableModalTitle" style="margin-bottom:8px">New Spreadsheet</h2>
      <p style="color:var(--text-dim); font-size:0.85rem; margin-bottom:24px">Define your columns ‚Äî each spreadsheet
        auto-syncs to a Knowledge Base skill.</p>
      <input type="hidden" id="inv-tbl-id-hidden">
      <label>Spreadsheet Name</label><input id="inv-tbl-name" class="input" placeholder="e.g. Electronics, Food Menu"
        required>
      <div style="margin-top:20px">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
          <label style="margin:0">Columns</label>
          <button type="button" class="btn btn-secondary" style="padding:4px 12px; font-size:0.75rem"
            onclick="addInvColumn()">+ Add Column</button>
        </div>
        <div id="inv-columns-list" style="display:flex; flex-direction:column; gap:8px"></div>
      </div>
      <div style="display:flex; gap:12px; margin-top:32px">
        <button class="btn btn-primary" style="flex:1" onclick="saveInvTable()">Save Spreadsheet</button>
        <button class="btn btn-secondary" onclick="closeModal('invTableModal')">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Modal: Custom Alert -->
  <div class="modal-overlay" id="customAlertModal" style="display:none; z-index: 9999;">
    <div class="modal" style="max-width: 400px; text-align: center; padding: 32px 24px;">
      <div
        style="width: 48px; height: 48px; background: rgba(239, 68, 68, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px auto; color: #ef4444;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
      </div>
      <h2 style="margin-bottom: 12px; font-size: 1.2rem;">Action Required</h2>
      <p id="customAlertMessage"
        style="color:var(--text-dim); font-size: 0.95rem; margin-bottom: 24px; line-height: 1.5;"></p>
      <button class="btn btn-primary" onclick="closeModal('customAlertModal')" style="width: 100%;">Understood</button>
    </div>
  </div>

  <!-- Modal: Admin User -->
  <div class="modal-overlay" id="adminUserModal">
    <div class="modal">
      <h2 style="margin-bottom:8px">System Role & Credits</h2>
      <p style="color:var(--text-dim); font-size:0.85rem; margin-bottom:32px">Modify privileges and balance for <span
          id="admin-um-email" style="font-weight:bold; color:var(--text)"></span>.</p>
      <form onsubmit="event.preventDefault(); saveAdminUser();">
        <input type="hidden" id="admin-um-id">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px">
          <div>
            <label>System Role</label>
            <select id="admin-um-role" class="input">
              <option value="FREE">FREE</option>
              <option value="PREMIUM">PREMIUM</option>
              <option value="ENTERPRISE">ENTERPRISE</option>
              <option value="ADMIN">ADMIN</option>
            </select>
          </div>
          <div>
            <label>Credits Balance</label>
            <input type="number" id="admin-um-credits" class="input" placeholder="0" required>
          </div>
        </div>
        <div style="display:flex; gap:12px; margin-top:32px">
          <button type="submit" class="btn btn-primary" style="flex:1">Save Changes</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('adminUserModal')">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Upload Image -->
  <div class="modal-overlay" id="uploadImageModal">
    <div class="modal" style="max-width:500px">
      <h2 style="margin-bottom:8px">Upload Image</h2>
      <p style="color:var(--text-dim); font-size:0.85rem; margin-bottom:24px">Upload an image to your storage. Max 5MB
        per file. Supported: JPEG, PNG, GIF, WebP.</p>
      <div id="upload-drop-zone"
        style="border:2px dashed var(--border); border-radius:16px; padding:40px 24px; text-align:center; cursor:pointer; transition:0.2s; background:var(--bg)"
        onclick="document.getElementById('upload-file-input').click()"
        ondragover="event.preventDefault(); this.style.borderColor='var(--primary)'; this.style.background='var(--surface-elevated)'"
        ondragleave="this.style.borderColor='var(--border)'; this.style.background='var(--bg)'"
        ondrop="event.preventDefault(); this.style.borderColor='var(--border)'; this.style.background='var(--bg)'; handleUploadDrop(event)">
        <div id="upload-preview" style="display:none; margin-bottom:16px">
          <img id="upload-preview-img" style="max-width:100%; max-height:200px; border-radius:12px; object-fit:contain"
            alt="preview">
        </div>
        <div id="upload-placeholder">
          <div style="font-size:2rem; margin-bottom:8px">üì∏</div>
          <div style="font-size:0.9rem; font-weight:600; color:var(--text)">Drop image here or click to browse</div>
          <div style="font-size:0.75rem; color:var(--text-dim); margin-top:4px">JPEG, PNG, GIF, WebP ‚Äî Max 5MB</div>
        </div>
      </div>
      <input type="file" id="upload-file-input" style="display:none" accept="image/jpeg,image/png,image/gif,image/webp"
        onchange="handleUploadSelect(event)">
      <div style="display:flex; gap:12px; margin-top:24px">
        <button class="btn btn-primary" style="flex:1" id="upload-submit-btn" onclick="submitUpload()" disabled>Upload
          Image</button>
        <button class="btn btn-secondary" onclick="closeModal('uploadImageModal'); resetUploadModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Modal: Trigger Photo -->
  <div class="modal-overlay" id="triggerPhotoModal">
    <div class="modal" style="max-width:600px">
      <h2 id="triggerPhotoModalTitle" style="margin-bottom:8px">Create Trigger Photo</h2>
      <p style="color:var(--text-dim); font-size:0.85rem; margin-bottom:24px">Configure an image that the AI sends when
        users say specific trigger words.</p>
      <input type="hidden" id="tp-id-hidden">

      <label>Select Image</label>
      <div style="display:flex; gap:12px; align-items:flex-start; margin-bottom:20px">
        <select id="tp-image-select" class="input" style="flex:1; margin:0" onchange="previewTriggerImage()">
          <option value="">-- Choose an uploaded image --</option>
        </select>
        <div id="tp-image-preview"
          style="width:80px; height:80px; border-radius:12px; border:1px solid var(--border); background:var(--bg); display:flex; align-items:center; justify-content:center; overflow:hidden; flex-shrink:0">
          <span style="font-size:0.7rem; color:var(--text-dim)">Preview</span>
        </div>
      </div>

      <label>Trigger Words or Phrases</label>
      <p style="font-size:0.7rem; color:var(--text-dim); margin-top:-4px; margin-bottom:8px">Comma-separated phrases
        that trigger this image (e.g. "send me photo, send me menu, show me the picture")</p>
      <input id="tp-trigger-words" class="input" placeholder="e.g. send me photo, send me menu, show me the picture"
        style="margin-top:0">

      <div
        style="background:var(--bg); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:20px">
        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin-bottom:12px">
          <input type="checkbox" id="tp-auto-send" style="accent-color:var(--primary)"
            onchange="document.getElementById('tp-threshold-row').style.display = this.checked ? 'flex' : 'none'">
          <span style="font-size:0.85rem; font-weight:600">Auto-send to client after message threshold</span>
        </label>
        <div id="tp-threshold-row" style="display:none; align-items:center; gap:10px">
          <span style="font-size:0.8rem; color:var(--text-dim)">Send after</span>
          <input type="number" id="tp-threshold" class="input" value="10" min="1" max="100"
            style="width:80px; margin:0; text-align:center">
          <span style="font-size:0.8rem; color:var(--text-dim)">messages</span>
        </div>
      </div>

      <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin-bottom:0">
        <input type="checkbox" id="tp-kb-skill" style="accent-color:var(--primary)">
        <span style="font-size:0.85rem; font-weight:600">Register as Knowledge Base Skill</span>
      </label>
      <p style="font-size:0.7rem; color:var(--text-dim); margin-top:4px; margin-bottom:20px">When enabled, the trigger
        configuration will be added to your Knowledge Base so the AI knows about this trigger.</p>

      <div style="display:flex; gap:12px; margin-top:24px">
        <button class="btn btn-primary" style="flex:1" onclick="saveTriggerPhoto()">Save Trigger Photo</button>
        <button class="btn btn-secondary" onclick="closeModal('triggerPhotoModal')">Cancel</button>
      </div>
    </div>
  </div>

  <script src="/config-client.js"></script>
  <script>
    const sb = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
    function escapeHtml(unsafe) {
      if (typeof unsafe !== 'string') return unsafe;
      return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }
    function copyText(text, btn) {
      navigator.clipboard.writeText(text).then(() => {
        const orig = btn.innerHTML;
        btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> Copied!';
        setTimeout(() => btn.innerHTML = orig, 1500);
      });
    }
    let currentSession = null;
    let me = null;
    let kbOptions = [];
    let exchangeRates = { USD: 1, PHP: 1 };
    let displayCurrency = 'PHP'; // Target Default Fixed

    async function loadRates() {
      try {
        const res = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
        const data = await res.json();
        exchangeRates = data.rates;
        // Make sure the dropdown reflects the initial variable in case it missed it
        document.getElementById('currency-selector').value = displayCurrency;
        document.getElementById('currency-rate-info').innerText = `Live Rates: 1 USD = ${exchangeRates[displayCurrency] || 1} ${displayCurrency} (Updated: ${new Date().toLocaleTimeString()})`;
      } catch (e) { console.error("Rate fetch failed:", e); }
    }

    function formatPrice(usdPrice) {
      const rate = exchangeRates[displayCurrency] || 1;
      const converted = parseFloat(usdPrice) * rate;
      const symbols = { USD: '$', PHP: '‚Ç±', EUR: '‚Ç¨', GBP: '¬£', JPY: '¬•' };
      return `${symbols[displayCurrency] || displayCurrency} ${converted.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    async function updateCurrency() {
      displayCurrency = document.getElementById('currency-selector').value;

      // Save to database
      try {
        await fetch('/api/me/currency', {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${currentSession.access_token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ currency: displayCurrency })
        });
      } catch (e) {
        console.error("Failed to save currency", e);
      }

      await loadRates();
    }
    let pagesCache = [];

    async function updateSnippetTheme(pageId, widgetKey, theme) {
      const codeEl = document.getElementById('snippet-code-' + pageId);
      if (codeEl) {
        // Appending ?v=Date.now() ensures that users get the latest script without browser caching issues
        codeEl.innerText = `<script src="${window.location.origin}/blockscom-chat.js?v=${Date.now()}" data-key="${widgetKey}" data-theme="${theme}" data-api="${window.location.origin}"></scr` + `ipt>`;
      }
      try {
        await fetch('/api/pages/theme', {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${currentSession.access_token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ id: pageId, theme: theme })
        });

        // Update the cache so re-renders don't lose the selection
        const idx = pagesCache.findIndex(pg => pg.id === pageId);
        if (idx !== -1) pagesCache[idx].widget_theme = theme;
      } catch (e) {
        console.error("Failed to save theme", e);
      }
    }

    async function init() {
      const { data } = await sb.auth.getSession();
      if (!data.session) { window.location.href = '/login'; return; }
      currentSession = data.session;

      if (data.session.user && data.session.user.email) {
        document.getElementById('u-email').innerText = data.session.user.email;
      }

      const cachedMeStr = localStorage.getItem('blockscom_user_profile');
      if (cachedMeStr) {
        try {
          const cachedMe = JSON.parse(cachedMeStr);
          document.getElementById('u-tier').innerText = `TIER: ${cachedMe.role}`;
          document.getElementById('u-credits').innerText = `Credits: ${cachedMe.credits.toLocaleString()}`;
          if (cachedMe.role === 'ADMIN') {
            document.getElementById('admin-nav').style.display = 'flex';
            document.getElementById('admin-logs-nav').style.display = 'flex';
          }
          if (cachedMe.currency) displayCurrency = cachedMe.currency;
        } catch (e) { }
      }

      // Get URL params for view routing
      const urlParams = new URLSearchParams(window.location.search);
      const viewToLoad = urlParams.get('view') || 'pages';

      // Render structure instantly, start background tasks
      showView(viewToLoad);

      // Fetch user profile asynchronously and populate
      fetch('/api/me', { headers: { 'Authorization': `Bearer ${currentSession.access_token}` } })
        .then(async res => {
          if (!res.ok) { logout(); return; }
          me = await res.json();
          localStorage.setItem('blockscom_user_profile', JSON.stringify(me));

          if (me.currency) {
            displayCurrency = me.currency;
          }

          document.getElementById('u-email').innerText = me.email;
          document.getElementById('u-tier').innerText = `TIER: ${me.role}`;
          document.getElementById('u-credits').innerText = `Credits: ${me.credits.toLocaleString()}`;
          if (me.role === 'ADMIN') {
            document.getElementById('admin-nav').style.display = 'flex';
            document.getElementById('admin-logs-nav').style.display = 'flex';
          }

          await loadRates();

          // Listen for inventory table changes
          sb.channel('public:inventory_rows')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'inventory_rows', filter: `profile_id=eq.${me.id}` }, payload => {
              // Refresh detail view if open
              if (document.getElementById('inv-detail-view').style.display !== 'none' && currentInvTableId) {
                openInvDetail(currentInvTableId);
              }
            })
            .subscribe();
        })
        .catch(console.error);
    }

    let pagesLoaded = false;
    let kbLoaded = false;

    async function loadKbOptions() {
      const res = await fetch('/api/knowledge', { headers: { 'Authorization': `Bearer ${currentSession.access_token}` } });
      kbOptions = await res.json();
      kbLoaded = true;
    }

    async function loadPages() {
      if (pagesLoaded) {
        renderPagesList();
        return; // Don't re-fetch on every toggle if already loaded
      }
      try {
        const res = await fetch('/api/pages', { headers: { 'Authorization': `Bearer ${currentSession.access_token}` } });
        pagesCache = await res.json();

        // Fetch stats for FB Pages analytics
        try {
          const statsRes = await fetch('/api/logs/stats', { headers: { 'Authorization': `Bearer ${currentSession.access_token}` } });
          const statsData = await statsRes.json();
          pagesCache = pagesCache.map(p => ({
            ...p,
            stats: statsData[p.id] || { userCount: 0, replyCount: 0 }
          }));
        } catch (se) {
          console.error("Failed to load stats", se);
        }

        pagesLoaded = true;
        renderPagesList();
      } catch (e) {
        console.error("Failed to load pages", e);
      }
    }

    function renderPagesList() {
      const list = document.getElementById('pages-list');
      if (!pagesLoaded) {
        list.innerHTML = '<div class="empty-state"><h3>Loading Automations...</h3><p style="opacity:0.6; margin-top:8px;">Fetching your latest configurations</p></div>';
        return;
      }
      if (pagesCache.length === 0) {
        list.innerHTML = '<div class="empty-state"><h3>No Automations Found</h3><p>Create your first Facebook Page webhook to get started.</p></div>';
        return;
      }
      list.innerHTML = pagesCache.map(p => `
        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:20px; gap:8px">
            <div style="min-width:0"><div style="font-weight:700; font-size:1.1rem; word-break:break-word">${escapeHtml(p.name)}</div><div style="font-size:0.75rem; color:var(--text-dim); margin-top:2px; word-break:break-all">ID: ${escapeHtml(p.fb_page_id)}</div></div>
            <div class="badge ${p.is_enabled ? 'badge-premium' : 'badge-free'}" style="flex-shrink:0">${p.is_enabled ? 'Active' : 'Disabled'}</div>
          </div>
          <div style="display:flex; gap:10px; margin-bottom:16px;">
            <div style="background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:10px 8px; flex:1; text-align:center;">
              <div style="font-size:0.65rem; color:var(--text-dim); text-transform:uppercase; font-weight:700;">Users</div>
              <div style="font-size:1.1rem; font-weight:700; color:var(--text);">${p.stats ? p.stats.userCount : 0}</div>
            </div>
            <div style="background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:10px 8px; flex:1; text-align:center;">
              <div style="font-size:0.65rem; color:var(--text-dim); text-transform:uppercase; font-weight:700;">Bot Replies</div>
              <div style="font-size:1.1rem; font-weight:700; color:var(--primary);">${p.stats ? p.stats.replyCount : 0}</div>
            </div>
          </div>
          <div style="background:var(--bg); border:1px solid var(--border); border-radius:10px; padding:12px; margin-bottom:10px">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; flex-wrap:wrap; gap:6px">
              <div style="font-size:0.65rem; font-weight:700; color:var(--text-dim); text-transform:uppercase">Webhook Endpoint</div>
              <button class="btn btn-secondary" style="padding:4px 8px; font-size:0.65rem; display:inline-flex; align-items:center; gap:4px; flex-shrink:0" onclick="copyText('${window.location.origin}/webhook?page=${p.id}', this)">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                Copy
              </button>
            </div>
            <code style="font-size:0.75rem; color:var(--text-muted); word-break:break-all; display:block; line-height:1.4">${window.location.origin}/webhook?page=${p.id}</code>
          </div>
          <div style="background:var(--bg); border:1px solid var(--border); border-radius:10px; padding:12px; margin-bottom:10px">
            <div style="display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; margin-bottom:8px; gap:6px">
              <div style="display:flex; align-items:center; gap:6px; flex-wrap:wrap">
                <div style="font-size:0.65rem; font-weight:700; color:var(--text-dim); text-transform:uppercase;">Website Plugin Snippet</div>
                <button class="btn btn-secondary" style="padding:4px 8px; font-size:0.65rem; display:inline-flex; align-items:center; gap:4px; flex-shrink:0" onclick="copyText(document.getElementById('snippet-code-${p.id}').innerText, this)">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                  Copy
                </button>
              </div>
              <select class="input" style="width:auto; min-width:0; margin:0; padding:4px 8px; font-size:0.7rem; max-width:100%" onchange="updateSnippetTheme('${p.id}', '${p.widget_key || ''}', this.value)">
                <option value="default" ${p.widget_theme === 'default' || !p.widget_theme ? 'selected' : ''}>Default Theme</option>
                <option value="white" ${p.widget_theme === 'white' ? 'selected' : ''}>White Theme</option>
                <option value="black" ${p.widget_theme === 'black' ? 'selected' : ''}>Black Theme</option>
                <option value="glass" ${p.widget_theme === 'glass' ? 'selected' : ''}>Glassmorphism (Futuristic)</option>
                <option value="cyberpunk" ${p.widget_theme === 'cyberpunk' ? 'selected' : ''}>Cyberpunk (Aesthetic)</option>
              </select>
            </div>
            <code id="snippet-code-${p.id}" style="font-size:0.7rem; color:var(--text-muted); word-break:break-all; display:block; line-height:1.4">&lt;script src="${window.location.origin}/blockscom-chat.js?v=${Date.now()}" data-key="${p.widget_key || ''}" data-theme="${p.widget_theme || 'default'}" data-api="${window.location.origin}"&gt;&lt;/script&gt;</code>
          </div>
          <div style="background:var(--bg); border:1px solid var(--border); border-radius:10px; padding:12px; margin-bottom:16px">
            <div style="font-size:0.65rem; font-weight:700; color:var(--text-dim); text-transform:uppercase; margin-bottom:6px">Active Skills (${(p.knowledge_base || []).filter(k => !k.startsWith('prod:') && !k.startsWith('cat:')).length})</div>
            <div style="font-size:0.8rem; color:var(--text-muted)">${(p.knowledge_base && p.knowledge_base.length) ? p.knowledge_base.filter(k => !k.startsWith('prod:') && !k.startsWith('cat:')).slice(0, 3).join(', ') + (p.knowledge_base.length > 3 ? ' ...' : '') : 'No skills linked yet'}</div>
          </div>
          <div style="display:flex; gap:10px">
            <button class="btn btn-secondary" style="flex:1" onclick="openPageModal('${p.id}')">Edit Config</button>
            <button class="btn btn-danger" onclick="deletePage('${p.id}')">Del</button>
          </div>
        </div>
      `).join('');
    }

    async function loadKb() {
      if (kbLoaded) {
        renderKbListBase();
        return; // Don't re-fetch on every toggle if already loaded
      }
      await loadKbOptions();
      renderKbListBase();
    }

    function renderKbListBase() {
      const list = document.getElementById('kb-list');
      if (!kbLoaded) {
        list.innerHTML = '<div class="empty-state"><h3>Loading Knowledge Base Skills...</h3><p style="opacity:0.6; margin-top:8px">Fetching your skills...</p></div>';
        return;
      }
      // Filter out PERSONALITY ‚Äî it's always active and managed from the Automations page
      const visibleKb = kbOptions.filter(k => k.title !== 'PERSONALITY');
      if (visibleKb.length === 0) {
        list.innerHTML = '<div class="empty-state"><h3>Your Knowledge is Empty</h3><p>Add skills to help the AI understand your business.</p></div>';
        return;
      }
      list.innerHTML = visibleKb.map(k => {
        const isSynced = k.title === 'Product Catalog';
        return `
        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:16px">
             <div style="font-weight:700; font-size:1rem">${escapeHtml(k.title)}</div>
             <div style="display:flex; gap:8px; align-items:center;">
               ${isSynced ? `<button class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.70rem;" onclick="forceSyncProducts()">‚ü≥ Sync</button>` : ''}
               <div class="badge badge-free">Skill Entry ${isSynced ? '(Synced)' : ''}</div>
             </div>
          </div>
          <div style="font-size:0.85rem; color:var(--text-dim); height:60px; overflow:hidden; mask-image:linear-gradient(to bottom, black 50%, transparent 100%)">${escapeHtml(k.content)}</div>
          <div style="display:flex; gap:10px; margin-top:20px; position:relative">
            <button class="btn btn-secondary" style="flex:1" onclick="openKbModal('${k.id}')">Edit Skill</button>
            <button class="btn btn-secondary" onclick="toggleAddToPage('${k.id}', '${escapeHtml(k.title).replace(/'/g, "\\'")}')">Add to Page</button>
            <div class="atp-popup" id="atp-popup-${k.id}"></div>
            <button class="btn btn-danger" onclick="deleteKb('${k.id}')">Del</button>
          </div>
        </div>
      `;
      }).join('');
    }

    async function scanFiles() {
      const res = await fetch('/api/kb/scan-files', { method: 'POST', headers: { 'Authorization': `Bearer ${currentSession.access_token}` } });
      const j = await res.json();
      if (j.success) {
        alert(`Imported ${j.count} new skills from markdown files.`);
        kbLoaded = false;
        await loadKb();
      } else {
        alert("Import failed: " + j.error);
      }
    }

    async function exportKbMd() {
      if (!kbOptions || kbOptions.length === 0) {
        alert('No knowledge entries to export.');
        return;
      }
      // Create a zip-like download of all KB as individual .md strings bundled in one text
      // For simplicity, export as a single combined .md file
      let md = '';
      kbOptions.forEach(k => {
        md += `---\n# ${k.title}\n---\n\n${k.content}\n\n\n`;
      });

      const blob = new Blob([md], { type: 'text/markdown' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'blockscom_knowledge_base.md';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
    }

    async function importKbFiles(event) {
      const files = event.target.files;
      if (!files || files.length === 0) return;

      const entries = [];
      for (const file of files) {
        const text = await file.text();
        const title = file.name.replace(/\.(md|txt)$/i, '').split(/[-_]/).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        entries.push({ title, content: text });
      }

      try {
        const res = await fetch('/api/kb/import', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentSession.access_token}`
          },
          body: JSON.stringify({ entries })
        });

        const result = await res.json();
        if (!res.ok) {
          alert('Import failed: ' + (result.error || 'Unknown error'));
        } else {
          alert(`Imported ${result.imported} skill(s). ${result.skipped > 0 ? result.skipped + ' skipped (duplicates).' : ''}`);
          kbLoaded = false;
          await loadKb();
        }
      } catch (e) {
        alert('Import error: ' + e.message);
      }

      event.target.value = '';
    }

    async function loadLogs() {
      document.getElementById('logs-table').innerHTML = '<tr><td colspan="4" class="empty-state">Loading activity...</td></tr>';
      const res = await fetch('/api/logs', { headers: { 'Authorization': `Bearer ${currentSession.access_token}` } });
      const logs = await res.json();
      document.getElementById('logs-table').innerHTML = logs.map(l => `
        <tr>
          <td style="color:var(--text-dim); white-space:nowrap">${new Date(l.created_at).toLocaleTimeString()}</td>
          <td style="font-weight:600">${escapeHtml(l.fb_pages?.name || '---')}</td>
          <td><span class="badge badge-free">${l.type}</span></td>
          <td style="max-width:400px; font-size:0.85rem; line-height:1.4;">
            ${l.payload ? `
              ${l.payload.sender ? `<div style="font-size:0.7rem; color:var(--primary); font-family:monospace; margin-bottom:4px;">Sender ID: ${escapeHtml(l.payload.sender)}</div>` : ''}
              ${l.payload.in ? `<div style="margin-bottom:4px;"><strong>User:</strong> <span style="color:var(--text-dim);">${escapeHtml(l.payload.in)}</span></div>` : ''}
              ${l.payload.out ? `<div><strong>AI:</strong> <span style="color:var(--text);">${escapeHtml(l.payload.out)}</span></div>` : ''}
            ` : 'No payload data'}
          </td>
        </tr>
      `).join('') || '<tr><td colspan="4" class="empty-state">No recent activity logged.</td></tr>';
    }

    async function exportLogsCSV() {
      try {
        const res = await fetch('/api/logs', { headers: { 'Authorization': `Bearer ${currentSession.access_token}` } });
        const logs = await res.json();

        if (!logs || logs.length === 0) {
          alert('No live data to export.');
          return;
        }

        const headers = ['Timestamp', 'Page Name', 'Type', 'Sender ID', 'User Message', 'AI Reply'];
        const rows = logs.map(l => {
          return [
            `"${new Date(l.created_at).toLocaleString()}"`,
            `"${(l.fb_pages?.name || '').replace(/"/g, '""')}"`,
            `"${l.type}"`,
            `"${l.payload?.sender || ''}"`,
            `"${(l.payload?.in || '').replace(/"/g, '""')}"`,
            `"${(l.payload?.out || '').replace(/"/g, '""')}"`
          ].join(',');
        });

        const csvContent = "data:text/csv;charset=utf-8," + headers.join(',') + '\\n' + rows.join('\\n');
        const encodedUri = encodeURI(csvContent);
        const a = document.createElement('a');
        a.setAttribute('href', encodedUri);
        a.setAttribute('download', 'live_activity_logs.csv');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } catch (err) {
        alert('Failed to construct export file: ' + err.message);
      }
    }

    async function analyzeLogs() {
      const btn = document.querySelector('button[onclick="analyzeLogs()"]');
      const originalText = btn.innerText;
      btn.innerHTML = '<span style="animation: pulse 1.5s infinite">‚ú® Analyzing... Please wait</span>';
      btn.disabled = true;

      try {
        const res = await fetch('/api/logs/analyze', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${currentSession.access_token}` }
        });
        const result = await res.json();

        if (!res.ok || result.error) {
          alert('Analysis Failed: ' + (result.error || 'Unknown error'));
          return;
        }

        if (me && me.role !== 'ADMIN') {
          me.credits = Math.max(0, (me.credits || 0) - 2);
          document.getElementById('u-credits').innerText = `Credits: ${me.credits.toLocaleString()}`;
          localStorage.setItem('blockscom_user_profile', JSON.stringify(me));
        }

        // Convert the markdown report to HTML
        const htmlContent = marked.parse(result.report);

        // Create a hidden container for the PDF generation
        const container = document.createElement('div');
        container.innerHTML = `
          <div style="font-family: 'Plus Jakarta Sans', sans-serif; color: #000; padding: 40px; line-height: 1.6;">
            <h1 style="color: #000; border-bottom: 2px solid #ccc; padding-bottom: 10px;">Chatlogs AI Analysis Report</h1>
            <div style="margin-top: 20px;">
              ${htmlContent}
            </div>
            <div style="margin-top: 40px; font-size: 0.8rem; color: #666; text-align: center;">
              Generated on ${new Date().toLocaleString()} by BLOCKSCOM AI
            </div>
          </div>
        `;
        document.body.appendChild(container);

        // Define PDF options
        const opt = {
          margin: 0,
          filename: 'Blockscom_AI_Chatlog_Analysis.pdf',
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };

        // Generate and save the PDF
        await html2pdf().set(opt).from(container).save();

        // Cleanup
        document.body.removeChild(container);
      } catch (e) {
        alert('An error occurred during analysis: ' + e.message);
      } finally {
        btn.innerText = originalText;
        btn.disabled = false;
      }
    }

    async function loadAdminUsers() {
      const res = await fetch('/api/admin/users', { headers: { 'Authorization': `Bearer ${currentSession.access_token}` } });
      const users = await res.json();
      document.getElementById('admin-users').innerHTML = users.map(u => `
        <tr>
          <td><div style="font-weight:600">${escapeHtml(u.email)}</div><div style="font-size:0.7rem; color:var(--text-dim)">${u.id}</div></td>
          <td><span class="badge ${u.role === 'ADMIN' ? 'badge-premium' : 'badge-free'}">${u.role}</span></td>
          <td style="font-weight:700">${u.credits.toLocaleString()}</td>
          <td><button class="btn btn-secondary" onclick="editUser('${escapeHtml(u.id)}', ${u.credits}, '${escapeHtml(u.role)}', '${escapeHtml(u.email).replace(/'/g, "\\'")}')">Manage</button></td>
        </tr>
      `).join('');
    }

    function showView(view) {
      // Guard: only ADMIN can access the admin view
      if (view === 'admin' && (!me || me.role !== 'ADMIN')) {
        view = 'pages';
      }
      document.querySelectorAll('.view-section').forEach(d => d.style.display = 'none');
      document.getElementById('view-' + view).style.display = 'block';
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      const navId = view === 'admin' ? 'admin-nav' : view === 'admin-logs' ? 'admin-logs-nav' : 'nav-' + view;
      const nav = document.getElementById(navId);
      if (nav) nav.classList.add('active');
      if (view === 'admin') loadAdminUsers();
      if (view === 'admin-logs') { loadAdminLogs(); startAdminLogsSubscription(); }
      if (view === 'kb') loadKb();
      if (view === 'logs') loadLogs();
      if (view === 'pages') loadPages();
      if (view === 'products') loadInvTables();
      if (view === 'images') loadImages();
    }

    // ==================== FLEXIBLE INVENTORY SYSTEM JS ====================
    let invTablesCache = [];
    let currentInvTableId = null;
    let currentInvTableData = null;

    async function loadInvTables() {
      document.getElementById('inv-tables-list').innerHTML = '<div class="empty-state"><h3>Loading Spreadsheets...</h3><p style="opacity:0.6; margin-top:8px">Fetching your inventory data...</p></div>';
      try {
        const res = await fetch('/api/inventory/tables', { headers: { 'Authorization': `Bearer ${currentSession.access_token}` } });
        invTablesCache = await res.json();
      } catch (e) { invTablesCache = []; }

      const role = me?.role || 'FREE';
      const limits = { FREE: 1, PREMIUM: 10, ENTERPRISE: '‚àû', ADMIN: '‚àû' };
      const list = document.getElementById('inv-tables-list');
      if (invTablesCache.length === 0) {
        list.innerHTML = `<div class="card" style="padding:40px; text-align:center">
          <p style="color:var(--text-dim)">No spreadsheets yet. Create one to get started!</p>
          <p style="font-size:0.8rem; color:var(--text-dim); margin-top:8px">Your tier (${role}) allows up to <strong>${limits[role] || 1}</strong> spreadsheet(s).</p>
        </div>`;
        return;
      }
      list.innerHTML = invTablesCache.map(t => {
        const cols = (t.columns || []).map(c => c.label).join(', ');
        return `<div class="card" style="cursor:pointer" onclick="openInvDetail('${t.id}')">
          <div style="display:flex; justify-content:space-between; align-items:flex-start">
            <div>
              <h3 style="margin:0 0 6px 0">${escapeHtml(t.name)}</h3>
              <p style="font-size:0.8rem; color:var(--text-dim); margin:0">Columns: ${escapeHtml(cols) || 'None'}</p>
              <p style="font-size:0.7rem; color:var(--text-dim); margin:4px 0 0 0">KB: Inventory: ${escapeHtml(t.name)}</p>
            </div>
            <div style="display:flex; gap:8px">
              <button class="btn btn-secondary" style="padding:4px 10px; font-size:0.75rem" onclick="event.stopPropagation(); openInvTableModal('${t.id}')">Edit</button>
              <button class="btn btn-danger" style="padding:4px 10px; font-size:0.75rem" onclick="event.stopPropagation(); deleteInvTable('${t.id}')">Del</button>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    async function openInvDetail(tableId) {
      currentInvTableId = tableId;
      const t = invTablesCache.find(x => x.id === tableId);
      if (!t) return;
      currentInvTableData = t;
      document.getElementById('inv-list-view').style.display = 'none';
      document.getElementById('inv-detail-view').style.display = 'block';
      document.getElementById('inv-detail-title').innerText = t.name;
      document.getElementById('inv-detail-kb-link').innerText = `Auto-synced ‚Üí KB: "Inventory: ${t.name}"`;

      const cols = t.columns || [];
      document.getElementById('inv-detail-thead').innerHTML = `<tr>${cols.map(c => `<th>${escapeHtml(c.label)}</th>`).join('')}<th style="text-align:right; width:80px">Actions</th></tr>`;

      // Fetch rows
      try {
        const res = await fetch(`/api/inventory/tables/${tableId}/rows`, { headers: { 'Authorization': `Bearer ${currentSession.access_token}` } });
        const rows = await res.json();
        renderInvRows(cols, rows);
      } catch (e) { console.error(e); }
    }

    function renderInvRows(cols, rows) {
      const tbody = document.getElementById('inv-detail-tbody');
      if (!rows || rows.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${cols.length + 1}" class="empty-state">No rows yet. Click "+ Add Row" to start.</td></tr>`;
        return;
      }
      tbody.innerHTML = rows.map(r => {
        const cells = cols.map(c => {
          const val = r.data[c.key] ?? '';
          if (c.type === 'boolean') {
            return `<td><input type="checkbox" data-row="${r.id}" data-col="${c.key}" ${val ? 'checked' : ''}></td>`;
          }
          return `<td><input class="input" style="margin:0; padding:6px 8px; font-size:0.85rem" data-row="${r.id}" data-col="${c.key}" type="${c.type === 'number' ? 'number' : 'text'}" value="${escapeHtml(String(val))}"></td>`;
        }).join('');
        return `<tr>${cells}<td style="text-align:right"><button class="btn btn-danger" style="padding:4px 8px; font-size:0.7rem" onclick="deleteInvRow('${r.id}')">‚úï</button></td></tr>`;
      }).join('');
    }

    function addInvRow() {
      if (!currentInvTableData) return;
      const cols = currentInvTableData.columns || [];
      const tbody = document.getElementById('inv-detail-tbody');
      // Check if showing empty state
      if (tbody.querySelector('.empty-state')) tbody.innerHTML = '';
      const cells = cols.map(c => {
        if (c.type === 'boolean') {
          return `<td><input type="checkbox" data-row="new" data-col="${c.key}"></td>`;
        }
        return `<td><input class="input" style="margin:0; padding:6px 8px; font-size:0.85rem" data-row="new" data-col="${c.key}" type="${c.type === 'number' ? 'number' : 'text'}" value=""></td>`;
      }).join('');
      tbody.insertAdjacentHTML('beforeend', `<tr>${cells}<td style="text-align:right"><button class="btn btn-danger" style="padding:4px 8px; font-size:0.7rem" onclick="this.closest('tr').remove()">‚úï</button></td></tr>`);
    }

    async function saveInvRows() {
      if (!currentInvTableId || !currentInvTableData) return;
      const cols = currentInvTableData.columns || [];
      const tbody = document.getElementById('inv-detail-tbody');
      const trElements = tbody.querySelectorAll('tr');
      const rows = [];
      trElements.forEach(tr => {
        if (tr.querySelector('.empty-state')) return;
        const inputs = tr.querySelectorAll('input[data-col]');
        if (inputs.length === 0) return;
        const rowId = inputs[0].getAttribute('data-row');
        const data = {};
        inputs.forEach(inp => {
          const col = inp.getAttribute('data-col');
          const colDef = cols.find(c => c.key === col);
          if (inp.type === 'checkbox') {
            data[col] = inp.checked;
          } else if (colDef && colDef.type === 'number') {
            data[col] = parseFloat(inp.value) || 0;
          } else {
            data[col] = inp.value;
          }
        });
        rows.push({ id: rowId === 'new' ? undefined : rowId, data });
      });

      try {
        await fetch(`/api/inventory/tables/${currentInvTableId}/rows`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentSession.access_token}` },
          body: JSON.stringify({ rows })
        });
        alert('All changes saved & synced to KB!');
        await openInvDetail(currentInvTableId);
      } catch (e) { alert('Error saving: ' + e.message); }
    }

    async function deleteInvRow(rowId) {
      if (!confirm('Delete this row?')) return;
      try {
        await fetch(`/api/inventory/rows/${rowId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${currentSession.access_token}` } });
        await openInvDetail(currentInvTableId);
      } catch (e) { alert('Delete failed: ' + e.message); }
    }

    async function deleteInvTable(id) {
      if (!confirm('Delete this entire spreadsheet? All rows and the auto-KB entry will be removed.')) return;
      try {
        await fetch(`/api/inventory/tables/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${currentSession.access_token}` } });
        await loadInvTables();
      } catch (e) { alert('Delete failed: ' + e.message); }
    }

    function closeInvDetail() {
      document.getElementById('inv-detail-view').style.display = 'none';
      document.getElementById('inv-list-view').style.display = 'block';
      currentInvTableId = null;
      currentInvTableData = null;
      loadInvTables();
    }

    async function syncInvTable() {
      if (!currentInvTableId) return;
      try {
        await fetch(`/api/inventory/tables/${currentInvTableId}/sync`, { method: 'POST', headers: { 'Authorization': `Bearer ${currentSession.access_token}` } });
        alert('Synced to Knowledge Base!');
      } catch (e) { alert('Sync failed: ' + e.message); }
    }

    // Spreadsheet Templates
    const INV_TEMPLATES = {
      products: {
        name: 'Products',
        columns: [
          { key: 'col_name', label: 'Product Name', type: 'text' },
          { key: 'col_price', label: 'Price', type: 'number' },
          { key: 'col_stock', label: 'Stock', type: 'number' },
          { key: 'col_category', label: 'Category', type: 'text' },
          { key: 'col_description', label: 'Description', type: 'text' }
        ]
      },
      food: {
        name: 'Food Menu',
        columns: [
          { key: 'col_item', label: 'Item Name', type: 'text' },
          { key: 'col_price', label: 'Price', type: 'number' },
          { key: 'col_category', label: 'Category', type: 'text' },
          { key: 'col_available', label: 'Available', type: 'boolean' },
          { key: 'col_description', label: 'Description', type: 'text' }
        ]
      },
      appointments: {
        name: 'Appointments',
        columns: [
          { key: 'col_service', label: 'Service Name', type: 'text' },
          { key: 'col_duration', label: 'Duration (mins)', type: 'number' },
          { key: 'col_price', label: 'Price', type: 'number' },
          { key: 'col_available', label: 'Available', type: 'boolean' },
          { key: 'col_notes', label: 'Notes', type: 'text' }
        ]
      }
    };

    function openInvFromTemplate(templateKey) {
      document.getElementById('inv-template-menu').style.display = 'none';
      const tmpl = INV_TEMPLATES[templateKey];
      if (!tmpl) return;
      invColumnCounter = 0;
      document.getElementById('inv-tbl-id-hidden').value = '';
      document.getElementById('inv-tbl-name').value = tmpl.name;
      document.getElementById('inv-columns-list').innerHTML = '';
      document.getElementById('invTableModalTitle').innerText = 'New Spreadsheet (Template)';
      tmpl.columns.forEach(c => addInvColumn(c));
      document.getElementById('invTableModal').style.display = 'flex';
    }

    // Column Manager for Table Modal
    let invColumnCounter = 0;

    function openInvTableModal(editId = null) {
      invColumnCounter = 0;
      document.getElementById('inv-tbl-id-hidden').value = editId || '';
      document.getElementById('inv-tbl-name').value = '';
      document.getElementById('inv-columns-list').innerHTML = '';
      document.getElementById('invTableModalTitle').innerText = editId ? 'Edit Spreadsheet' : 'New Spreadsheet';

      if (editId) {
        const t = invTablesCache.find(x => x.id === editId);
        if (t) {
          document.getElementById('inv-tbl-name').value = t.name;
          (t.columns || []).forEach(c => addInvColumn(c));
        }
      }
      if (document.getElementById('inv-columns-list').children.length === 0) {
        // Add default columns for new table
        addInvColumn({ key: 'col_1', label: 'Product Name', type: 'text' });
        addInvColumn({ key: 'col_2', label: 'Price', type: 'number' });
        addInvColumn({ key: 'col_3', label: 'Stock', type: 'number' });
      }
      document.getElementById('invTableModal').style.display = 'flex';
    }

    function addInvColumn(preset = null) {
      invColumnCounter++;
      const key = preset?.key || `col_${Date.now()}_${invColumnCounter}`;
      const label = preset?.label || '';
      const type = preset?.type || 'text';
      const el = document.createElement('div');
      el.style.cssText = 'display:flex; gap:8px; align-items:center';
      el.innerHTML = `
        <input type="hidden" class="inv-col-key" value="${escapeHtml(key)}">
        <input class="input inv-col-label" style="flex:2; margin:0; padding:8px" placeholder="Column name" value="${escapeHtml(label)}">
        <select class="input inv-col-type" style="flex:1; margin:0; padding:8px">
          <option value="text" ${type === 'text' ? 'selected' : ''}>Text</option>
          <option value="number" ${type === 'number' ? 'selected' : ''}>Number</option>
          <option value="boolean" ${type === 'boolean' ? 'selected' : ''}>Yes/No</option>
        </select>
        <button type="button" class="btn btn-danger" style="padding:6px 10px; font-size:0.75rem" onclick="this.parentElement.remove()">‚úï</button>
      `;
      document.getElementById('inv-columns-list').appendChild(el);
    }

    async function saveInvTable() {
      const id = document.getElementById('inv-tbl-id-hidden').value;
      const name = document.getElementById('inv-tbl-name').value.trim();
      if (!name) { alert('Please enter a spreadsheet name.'); return; }
      const colRows = document.getElementById('inv-columns-list').children;
      const columns = [];
      for (const row of colRows) {
        const key = row.querySelector('.inv-col-key').value;
        const label = row.querySelector('.inv-col-label').value.trim();
        const type = row.querySelector('.inv-col-type').value;
        if (!label) { alert('All columns must have a name.'); return; }
        columns.push({ key, label, type });
      }
      if (columns.length === 0) { alert('Add at least one column.'); return; }

      try {
        const res = await fetch('/api/inventory/tables', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentSession.access_token}` },
          body: JSON.stringify({ id: id || undefined, name, columns })
        });
        const result = await res.json();
        if (!res.ok) { alert(result.error || 'Failed to save.'); return; }
        closeModal('invTableModal');
        await loadInvTables();
      } catch (e) { alert('Error: ' + e.message); }
    }

    async function importInvFile(event) {
      const file = event.target.files[0];
      if (!file || !currentInvTableId) return;
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const res = await fetch(`/api/inventory/tables/${currentInvTableId}/import`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentSession.access_token}` },
            body: JSON.stringify({ fileData: e.target.result })
          });
          const result = await res.json();
          if (!res.ok) { alert(result.error || result.message || 'Import failed.'); return; }
          alert(`Successfully imported ${result.imported} rows!`);
          await openInvDetail(currentInvTableId);
        } catch (err) { alert('Import error: ' + err.message); }
        event.target.value = '';
      };
      reader.readAsText(file);
    }

    async function exportInvCSV() {
      if (!currentInvTableId || !currentInvTableData) return;
      try {
        const res = await fetch(`/api/inventory/tables/${currentInvTableId}/rows`, { headers: { 'Authorization': `Bearer ${currentSession.access_token}` } });
        const rows = await res.json();
        const cols = currentInvTableData.columns || [];
        const headers = cols.map(c => `"${c.label}"`).join(',');
        const csvRows = rows.map(r => cols.map(c => `"${String(r.data[c.key] ?? '').replace(/"/g, '""')}"`).join(',')).join('\n');
        const csvContent = 'data:text/csv;charset=utf-8,' + headers + '\n' + csvRows;
        const a = document.createElement('a');
        a.href = encodeURI(csvContent);
        a.download = `${currentInvTableData.name.replace(/\s+/g, '_')}_export.csv`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
      } catch (e) { alert('Export failed: ' + e.message); }
    }

    // Inventory table selector for page modal
    async function renderInvTableSelector(selectedSet) {
      const list = document.getElementById('inv-table-selector-list');
      try {
        // Re-fetch to be current
        const res = await fetch('/api/inventory/tables', { headers: { 'Authorization': `Bearer ${currentSession.access_token}` } });
        const tables = await res.json();
        if (tables.length === 0) {
          list.innerHTML = '<p style="font-size:0.8rem; color:var(--text-dim); padding:12px">No inventory spreadsheets found. Create one in the Inventory tab first.</p>';
          return;
        }
        list.innerHTML = tables.map(t => {
          const kbTitle = `Inventory: ${t.name}`;
          return `<label class="kb-checkbox">
            <input type="checkbox" value="${escapeHtml(kbTitle)}" ${selectedSet.has(kbTitle) ? 'checked' : ''}>
            <span>üìä ${escapeHtml(t.name)}</span>
          </label>`;
        }).join('');
      } catch (e) {
        list.innerHTML = '<p style="font-size:0.8rem; color:var(--danger); padding:12px">Failed to load inventory tables.</p>';
      }
    }

    function updateWebhookUrl(systemId) {
      if (!systemId || systemId.startsWith('temp-')) {
        document.getElementById('modal-webhook-link').innerText = 'Save configuration first to generate your Webhook URL';
        document.getElementById('modal-webhook-link').style.color = 'var(--text-dim)';
        return;
      }
      const baseUrl = window.location.origin + '/webhook';
      document.getElementById('modal-webhook-link').innerText = `${baseUrl}?page=${systemId}`;
      document.getElementById('modal-webhook-link').style.color = 'var(--text)';
    }

    function copyWebhookLink(btn) {
      const link = document.getElementById('modal-webhook-link').innerText;
      if (link.includes('[YOUR_PAGE_ID]')) {
        showCustomAlert('Please enter your Facebook Page ID first before copying the webhook URL.');
        // Briefly focus the input to guide the user
        const pageIdInput = document.getElementById('p-id');
        if (pageIdInput) {
          closeModal('customAlertModal'); // To allow focus behind modal
          pageIdInput.focus();
        }
        return;
      }

      navigator.clipboard.writeText(link).then(() => {
        const originalText = btn.innerText;
        btn.innerText = 'Copied!';
        setTimeout(() => btn.innerText = originalText, 2000);
      });
    }

    function showCustomAlert(message) {
      document.getElementById('customAlertMessage').innerText = message;
      document.getElementById('customAlertModal').style.display = 'flex';
    }

    async function openPageModal(id = null) {
      document.getElementById('pageModalTitle').innerText = id ? 'Update Configuration' : 'New Automation Setup';

      // Preload KB data if not yet loaded so skill list is never empty
      if (!kbLoaded) {
        document.getElementById('kb-selector-list').innerHTML = '<p style="font-size:0.8rem; color:var(--text-dim); padding:12px">Loading skills...</p>';
        await loadKbOptions();
      }

      const targetId = id || ('temp-' + Date.now());
      updateWebhookUrl(targetId);
      document.getElementById('p-id-hidden').value = id || '';
      document.getElementById('p-name').value = '';
      document.getElementById('p-widget-name').value = '';
      document.getElementById('p-id').value = '';
      document.getElementById('p-vtok').value = '';
      document.getElementById('p-vtok').placeholder = 'Your secret phrase';
      document.getElementById('p-atok').value = '';
      document.getElementById('p-atok').placeholder = 'EAAb...';
      document.getElementById('p-vtok').readOnly = false;
      document.getElementById('p-atok').readOnly = false;
      document.getElementById('p-vtok').style.opacity = '1';
      document.getElementById('p-atok').style.opacity = '1';
      document.getElementById('p-vtok').style.cursor = 'text';
      document.getElementById('p-atok').style.cursor = 'text';

      let selected = new Set();

      if (id) {
        // Use cached pages data for instant modal opening (no API call)
        const p = pagesCache.find(p => p.id === id);
        if (p) {
          document.getElementById('p-name').value = p.name;
          document.getElementById('p-widget-name').value = p.widget_name || '';
          document.getElementById('p-id').value = p.fb_page_id;
          updateWebhookUrl(p.id);

          let modelVal = p.ai_model || 'arcee-ai/trinity-large-preview:free';
          // Migrate legacy model IDs
          if (modelVal === 'openai/gpt-oss-20b:free') modelVal = 'arcee-ai/trinity-large-preview:free';
          if (modelVal === 'openai/gpt-oss-120b:free') modelVal = 'arcee-ai/trinity-large-preview:free';
          if (modelVal === 'openai/gpt-5.2') modelVal = 'openai/gpt-5-nano';
          if (modelVal === 'anthropic/claude-3-sonnet') modelVal = 'openai/gpt-oss-20b';
          if (modelVal === 'anthropic/claude-3.5-sonnet') modelVal = 'openai/gpt-oss-20b';
          if (modelVal === 'google/gemini-pro') modelVal = 'google/gemini-2.5-flash-lite';
          if (modelVal === 'google/gemini-2.5-pro') modelVal = 'google/gemini-2.5-flash-lite';
          if (modelVal === 'openai/gpt-4o') modelVal = 'openai/gpt-oss-20b';
          if (modelVal === 'z-ai/glm-4.7-flash') modelVal = 'openai/gpt-oss-20b';
          if (modelVal === 'openai/gpt-5-mini') modelVal = 'openai/gpt-5-nano';
          if (modelVal === 'openai/gpt-5.2-chat') modelVal = 'openai/gpt-5-nano';
          if (modelVal === 'anthropic/claude-opus-4.6') modelVal = 'openai/gpt-5-nano';
          document.getElementById('p-model').value = modelVal;

          // Never prefill secret inputs with masked values; keep blank and show saved state in placeholder
          const vt = document.getElementById('p-vtok');
          const at = document.getElementById('p-atok');
          vt.value = '';
          at.value = '';
          vt.placeholder = p.verify_token ? 'Locked (Saved - Do not edit unless changing)' : 'Your secret phrase';
          at.placeholder = p.access_token ? 'Locked (Saved - Do not edit unless changing)' : 'EAAb...';

          if (p.verify_token) { vt.readOnly = true; vt.style.opacity = '0.6'; vt.style.cursor = 'not-allowed'; }
          if (p.access_token) { at.readOnly = true; at.style.opacity = '0.6'; at.style.cursor = 'not-allowed'; }

          selected = new Set(p.knowledge_base || []);
        }
      }

      renderKbSelectionList(kbOptions, selected);
      await renderInvTableSelector(selected);

      // Restrict model dropdown for FREE users
      const modelSelect = document.getElementById('p-model');
      const restrictionNote = document.getElementById('model-restriction-note');
      const isFree = me && me.role === 'FREE';
      Array.from(modelSelect.options).forEach(opt => {
        if (opt.dataset.tier === 'paid') {
          opt.disabled = isFree;
          opt.style.color = isFree ? '#555' : '';
        }
      });
      restrictionNote.style.display = isFree ? 'block' : 'none';
      // If FREE user currently has a paid model selected, force to default free model
      if (isFree && modelSelect.selectedOptions[0]?.dataset.tier === 'paid') {
        modelSelect.value = 'arcee-ai/trinity-large-preview:free';
      }

      document.getElementById('pageModal').style.display = 'flex';

      // Show personality picker for NEW automations only
      const personalitySection = document.getElementById('personality-picker-section');
      personalitySection.style.display = id ? 'none' : 'block';
      const personalityStatus = document.getElementById('personality-status');
      personalityStatus.style.display = 'none';
    }

    function renderKbSelectionList(options, selectedSet) {
      const list = document.getElementById('kb-selector-list');
      list.innerHTML = options.map(k => {
        const isPersonality = k.title === 'PERSONALITY';
        return `
        <label class="kb-checkbox" data-title="${escapeHtml(k.title.toLowerCase())}">
          <input type="checkbox" value="${escapeHtml(k.title)}" ${isPersonality || selectedSet.has(k.title) ? 'checked' : ''} ${isPersonality ? 'disabled' : ''}>
          <span>${isPersonality ? 'üß† ' : ''}${escapeHtml(k.title)}${isPersonality ? ' <span style="font-size:0.7rem; color:#c084fc; margin-left:4px">(Always Active)</span>' : ''}</span>
        </label>
      `;
      }).join('') || '<p style="font-size:0.8rem; color:var(--text-dim); padding:12px">No knowledge skills found. Create some in the Knowledge Base tab.</p>';
    }

    function filterSkills(query) {
      const q = query.toLowerCase();
      document.querySelectorAll('#kb-selector-list .kb-checkbox').forEach(el => {
        const title = el.getAttribute('data-title');
        el.style.display = title.includes(q) ? 'flex' : 'none';
      });
    }

    async function savePage() {
      const idStr = document.getElementById('p-id-hidden').value;
      const vTok = document.getElementById('p-vtok').value;
      if (!idStr && !vTok) {
        alert('Verify Token is required for new webhooks.');
        return;
      }

      const aTok = document.getElementById('p-atok').value;
      const kbSelected = Array.from(document.querySelectorAll('#kb-selector-list input:checked')).map(i => i.value);
      const invSelected = Array.from(document.querySelectorAll('#inv-table-selector-list input:checked')).map(i => i.value);

      const combinedSelections = [...kbSelected, ...invSelected];

      const body = {
        id: document.getElementById('p-id-hidden').value || undefined,
        name: document.getElementById('p-name').value,
        widget_name: document.getElementById('p-widget-name').value || undefined,
        fb_page_id: document.getElementById('p-id').value,
        verify_token: vTok || undefined, // If locked/blank, server logic ignores it
        access_token: aTok || undefined,
        ai_model: document.getElementById('p-model').value,
        knowledge_base: combinedSelections
      };

      closeModal('pageModal');

      if (body.id) {
        const idx = pagesCache.findIndex(p => p.id === body.id);
        if (idx > -1) pagesCache[idx] = { ...pagesCache[idx], ...body };
      } else {
        pagesCache.unshift({ ...body, id: 'temp-' + Date.now(), is_enabled: true, widget_key: 'Generating...' });
      }
      pagesLoaded = false;
      renderPagesList();

      fetch('/api/pages', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentSession.access_token}` }, body: JSON.stringify(body) })
        .then(async res => {
          if (!res.ok) throw new Error('Failed to save');
          const result = await res.json();
          // If this was a new page, show the real webhook URL
          if (result.id) {
            const webhookUrl = `${window.location.origin}/webhook?page=${result.id}`;
            alert('Webhook created successfully!\n\nYour Webhook URL (paste this into Facebook):\n' + webhookUrl);
          }
          pagesLoaded = false;
          loadPages();
        })
        .catch(err => alert('Error saving page: ' + err.message));
    }

    // ==================== TEMPLATE SYSTEM ====================

    const SKILL_TEMPLATES = {
      business_general: {
        title: 'Business Knowledge Base',
        icon: 'üè¢',
        desc: 'Set up a general knowledge base about your business ‚Äî info, policies, contact details, and more.',
        hasLang: true,
        fields: [
          { key: 'business', label: 'Business / Brand Name', placeholder: 'e.g. Acme Corp', type: 'text' },
          { key: 'industry', label: 'Industry / Business Type', placeholder: 'e.g. E-commerce, Restaurant, Salon', type: 'text' },
          { key: 'address', label: 'Address / Location', placeholder: 'e.g. 123 Main St, Makati City', type: 'text' },
          { key: 'contact', label: 'Contact Information', placeholder: 'e.g. Phone: 0917-xxx, Email: info@business.com', type: 'text' },
          { key: 'hours', label: 'Operating Hours', placeholder: 'e.g. Mon-Sat 9AM-8PM, Sun Closed', type: 'text' },
          { key: 'about', label: 'About the Business', placeholder: 'Brief description of what your business does, your mission, specialties, etc.', type: 'textarea' },
          { key: 'policies', label: 'Business Policies / Rules', placeholder: 'e.g. No refund after 7 days\nReservation required for groups of 10+\nPayment via GCash or Cash only', type: 'textarea' }
        ],
        generate: (d) => {
          const tl = d.lang === 'tagalog';
          const name = d.business || 'My Business';
          const policies = (d.policies || '').split('\n').filter(Boolean).map(p => `- ${p.trim()}`).join('\n');
          if (tl) {
            return `# ${name} ‚Äî Impormasyon ng Negosyo\n\n## Uri ng Negosyo\n${d.industry || 'Hindi tinukoy'}\n\n## Lokasyon / Address\n${d.address || 'Hindi tinukoy'}\n\n## Impormasyon sa Pakikipag-ugnayan\n${d.contact || 'Hindi tinukoy'}\n\n## Oras ng Operasyon\n${d.hours || 'Hindi tinukoy'}\n\n## Tungkol sa Negosyo\n${d.about || 'Walang paglalarawan.'}\n\n## Mga Patakaran ng Negosyo\n${policies || '- Walang tinukoy na patakaran.'}\n\n## Mga Tagubilin para sa AI\n- Laging sumagot sa Tagalog maliban kung English ang ginamit ng customer.\n- Magbigay ng tumpak na impormasyon batay sa kaalaman sa itaas.\n- Kung hindi mo alam ang sagot, sabihin na ipapasa sa human agent.\n- Maging magalang at propesyonal sa lahat ng oras.`;
          }
          return `# ${name} ‚Äî Business Information\n\n## Business Type\n${d.industry || 'Not specified'}\n\n## Location / Address\n${d.address || 'Not specified'}\n\n## Contact Information\n${d.contact || 'Not specified'}\n\n## Operating Hours\n${d.hours || 'Not specified'}\n\n## About the Business\n${d.about || 'No description provided.'}\n\n## Business Policies\n${policies || '- No policies specified.'}\n\n## AI Instructions\n- Always provide accurate information based on the knowledge above.\n- If you do not know the answer, let the customer know a human agent will follow up.\n- Be friendly and professional at all times.\n- Keep responses concise and helpful.`;
        }
      },
      customer_support: {
        title: 'Customer Support',
        icon: 'üéß',
        desc: 'Set up how the AI handles customer inquiries and support tickets.',
        hasLang: true,
        fields: [
          { key: 'business', label: 'Business / Brand Name', placeholder: 'e.g. Acme Corp', type: 'text' },
          { key: 'hours', label: 'Support Hours', placeholder: 'e.g. Mon-Fri 9AM-6PM PST', type: 'text' },
          { key: 'channels', label: 'Support Channels', placeholder: 'e.g. Messenger, Email, Phone', type: 'text' },
          { key: 'issues', label: 'Common Issues (one per line)', placeholder: 'Shipping delays\nWrong item received\nPayment issues', type: 'textarea' },
          { key: 'tone', label: 'Tone & Style', placeholder: 'e.g. Friendly and professional, empathetic', type: 'text' }
        ],
        generate: (d) => {
          const tl = d.lang === 'tagalog';
          const name = d.business || 'My Business';
          const issuesList = (d.issues || '').split('\n').filter(Boolean);
          if (tl) {
            return `# ${name} ‚Äî Customer Support Skill\n\n## Oras ng Support\n${d.hours || 'Hindi tinukoy'}\n\n## Mga Channel ng Support\n${d.channels || 'Messenger'}\n\n## Tono at Estilo\n${d.tone || 'Magiliw at propesyonal'}\n\n## Mga Karaniwang Isyu at Paano Haharapin\n${issuesList.map(i => `- **${i.trim()}**: Kilalanin ang isyu, humingi ng paumanhin, at magbigay ng solusyon o i-escalate.`).join('\n')}\n\n## Pangkalahatang Tagubilin\n- Laging batiin nang magiliw ang customer.\n- Kung hindi mo malutas ang isyu, ipaalam na may susunod na human agent.\n- Huwag magbahagi ng mga internal na patakaran o kumpidensyal na impormasyon.\n- Panatilihing maikli at nakakatulong ang mga sagot.\n- Sumagot sa Tagalog maliban kung English ang ginamit ng customer.`;
          }
          return `# ${name} ‚Äî Customer Support Skill\n\n## Support Hours\n${d.hours || 'Not specified'}\n\n## Support Channels\n${d.channels || 'Messenger'}\n\n## Tone & Style\n${d.tone || 'Friendly and professional'}\n\n## Common Issues & How to Handle\n${issuesList.map(i => `- **${i.trim()}**: Acknowledge the issue, apologize, and provide a solution or escalate.`).join('\n')}\n\n## General Instructions\n- Always greet the customer warmly.\n- If you cannot resolve the issue, let them know a human agent will follow up.\n- Never share internal policies or confidential information.\n- Keep responses concise and helpful.`;
        }
      },
      venue: {
        title: 'Venue Knowledge Base',
        icon: 'üèõÔ∏è',
        desc: 'Set up knowledge about your venue ‚Äî location, capacity, amenities, pricing, and event information.',
        hasLang: true,
        fields: [
          { key: 'venue_name', label: 'Venue Name', placeholder: 'e.g. Grand Ballroom, The Garden Events Place', type: 'text' },
          { key: 'venue_type', label: 'Venue Type', placeholder: 'e.g. Event Hall, Restaurant, Co-working Space, Resort', type: 'text' },
          { key: 'address', label: 'Address / Location', placeholder: 'e.g. 456 Event Rd, Quezon City, Metro Manila', type: 'text' },
          { key: 'capacity', label: 'Capacity / Size', placeholder: 'e.g. Up to 200 seated, 300 cocktail-style', type: 'text' },
          { key: 'amenities', label: 'Amenities / Features (one per line)', placeholder: 'Free parking\nAir-conditioned\nSound system included\nWiFi available\nCatering available', type: 'textarea' },
          { key: 'pricing', label: 'Pricing / Rates (one per line)', placeholder: 'Weekday: ‚Ç±15,000 for 4 hours\nWeekend: ‚Ç±25,000 for 4 hours\nOvertime: ‚Ç±3,000/hour', type: 'textarea' },
          { key: 'hours', label: 'Operating Hours', placeholder: 'e.g. Mon-Sun 8AM-10PM', type: 'text' },
          { key: 'booking', label: 'Booking / Contact Info', placeholder: 'e.g. Call 0917-xxx-xxxx or message us on Facebook to reserve', type: 'textarea' }
        ],
        generate: (d) => {
          const tl = d.lang === 'tagalog';
          const name = d.venue_name || 'My Venue';
          const amenities = (d.amenities || '').split('\n').filter(Boolean).map(a => `- ${a.trim()}`).join('\n');
          const pricing = (d.pricing || '').split('\n').filter(Boolean).map(p => `- ${p.trim()}`).join('\n');
          if (tl) {
            return `# ${name} ‚Äî Impormasyon ng Venue\n\n## Uri ng Venue\n${d.venue_type || 'Hindi tinukoy'}\n\n## Lokasyon / Address\n${d.address || 'Hindi tinukoy'}\n\n## Kapasidad\n${d.capacity || 'Hindi tinukoy'}\n\n## Mga Amenities at Features\n${amenities || '- Walang tinukoy.'}\n\n## Presyo at Rates\n${pricing || '- Walang tinukoy na presyo.'}\n\n## Oras ng Operasyon\n${d.hours || 'Hindi tinukoy'}\n\n## Paano Mag-book / Contact\n${d.booking || 'Makipag-ugnayan sa amin para sa reservation.'}\n\n## Mga Tagubilin para sa AI\n- Magbigay ng tumpak na impormasyon tungkol sa venue.\n- Kung may nagtatanong ng availability, sabihin na mag-message o tumawag para i-confirm.\n- Sumagot sa Tagalog maliban kung English ang ginamit ng customer.\n- Maging magiliw at nakakatulong sa lahat ng oras.`;
          }
          return `# ${name} ‚Äî Venue Information\n\n## Venue Type\n${d.venue_type || 'Not specified'}\n\n## Location / Address\n${d.address || 'Not specified'}\n\n## Capacity\n${d.capacity || 'Not specified'}\n\n## Amenities & Features\n${amenities || '- Not specified.'}\n\n## Pricing & Rates\n${pricing || '- No pricing specified.'}\n\n## Operating Hours\n${d.hours || 'Not specified'}\n\n## How to Book / Contact\n${d.booking || 'Contact us to make a reservation.'}\n\n## AI Instructions\n- Provide accurate venue information based on the knowledge above.\n- If someone asks about availability, ask them to message or call to confirm.\n- Be friendly and helpful at all times.\n- Keep responses clear and informative.`;
        }
      },
      appointment_booking: {
        title: 'Appointment Booking',
        icon: 'üìÖ',
        desc: 'Let the AI help customers schedule appointments and bookings.',
        hasLang: true,
        fields: [
          { key: 'business', label: 'Business / Brand Name', placeholder: 'e.g. GlowUp Salon', type: 'text' },
          { key: 'days', label: 'Available Days', placeholder: 'e.g. Monday to Saturday', type: 'text' },
          { key: 'hours', label: 'Available Hours', placeholder: 'e.g. 9:00 AM - 7:00 PM', type: 'text' },
          { key: 'services', label: 'Services Offered (one per line)', placeholder: 'Haircut - 30 min - ‚Ç±250\nHair Color - 2 hrs - ‚Ç±800\nManicure - 45 min - ‚Ç±200', type: 'textarea' },
          { key: 'instructions', label: 'Booking Instructions', placeholder: 'e.g. Ask for preferred date, time, and service. Confirm availability.', type: 'textarea' }
        ],
        generate: (d) => {
          const tl = d.lang === 'tagalog';
          const name = d.business || 'My Business';
          const services = (d.services || '').split('\n').filter(Boolean).map(s => `- ${s.trim()}`).join('\n');
          if (tl) {
            return `# ${name} ‚Äî Appointment Booking Skill\n\n## Available na Schedule\n- **Araw**: ${d.days || 'Lunes hanggang Biyernes'}\n- **Oras**: ${d.hours || '9 AM - 5 PM'}\n\n## Mga Serbisyo\n${services || '- Walang tinukoy na serbisyo.'}\n\n## Proseso ng Pag-book\n${d.instructions || '1. Itanong ang preferred na petsa at oras\n2. Itanong kung anong serbisyo ang gusto\n3. I-confirm ang detalye ng booking\n4. Magbigay ng confirmation message'}\n\n## Mga Tagubilin\n- Laging i-confirm ang petsa, oras, at serbisyo bago i-finalize.\n- Kung hindi available ang slot, mag-suggest ng pinakamalapit na available na oras.\n- Kuhanin ang pangalan at contact number ng customer.\n- Maging magiliw at propesyonal.\n- Sumagot sa Tagalog maliban kung English ang ginamit ng customer.`;
          }
          return `# ${name} ‚Äî Appointment Booking Skill\n\n## Available Schedule\n- **Days**: ${d.days || 'Monday to Friday'}\n- **Hours**: ${d.hours || '9 AM - 5 PM'}\n\n## Services\n${services || '- No services specified.'}\n\n## Booking Process\n${d.instructions || '1. Ask for preferred date and time\n2. Ask which service they want\n3. Confirm the booking details\n4. Provide a confirmation message'}\n\n## Instructions\n- Always confirm the date, time, and service before finalizing.\n- If a slot is unavailable, suggest the nearest available time.\n- Collect customer name and contact number.\n- Be warm and professional.`;
        }
      },
      order_taking: {
        title: 'Order Taking',
        icon: 'üõí',
        desc: 'Configure how the AI processes and takes customer orders.',
        fields: [
          { key: 'business', label: 'Business / Brand Name', placeholder: 'e.g. Pizza Palace', type: 'text' },
          { key: 'payment', label: 'Accepted Payment Methods', placeholder: 'e.g. Cash on Delivery, GCash, Credit Card', type: 'text' },
          { key: 'delivery', label: 'Delivery Options', placeholder: 'e.g. Standard (3-5 days), Express (1 day), Pickup', type: 'text' },
          { key: 'steps', label: 'Order Process Steps (one per line)', placeholder: 'Ask what they want to order\nConfirm items and quantities\nAsk for shipping address\nConfirm total and payment method', type: 'textarea' }
        ],
        generate: (d) => `# ${d.business || 'My Business'} ‚Äî Order Taking Skill\n\n## Payment Methods\n${(d.payment || '').split(',').map(p => `- ${p.trim()}`).join('\n')}\n\n## Delivery Options\n${(d.delivery || '').split(',').map(p => `- ${p.trim()}`).join('\n')}\n\n## Order Process\n${(d.steps || '').split('\n').filter(Boolean).map((s, i) => `${i + 1}. ${s.trim()}`).join('\n')}\n\n## Instructions\n- Always confirm the full order before finalizing.\n- Ask for customer name, contact info, and shipping address.\n- Use the place_order tool once all details are collected.\n- Be polite and efficient.`
      },
      returns_refunds: {
        title: 'Returns & Refunds',
        icon: 'üîÑ',
        desc: 'Define your return/refund policy for the AI to enforce.',
        fields: [
          { key: 'window', label: 'Return Window (days)', placeholder: 'e.g. 30', type: 'text' },
          { key: 'conditions', label: 'Return Conditions (one per line)', placeholder: 'Item must be unused\nOriginal packaging required\nReceipt must be provided', type: 'textarea' },
          { key: 'method', label: 'Refund Method', placeholder: 'e.g. Original payment method, Store credit', type: 'text' },
          { key: 'steps', label: 'Return Process Steps (one per line)', placeholder: 'Customer contacts support\nProvide order number\nShip item back\nRefund processed within 5-7 days', type: 'textarea' }
        ],
        generate: (d) => `# Returns & Refunds Policy\n\n## Return Window\n${d.window || '30'} days from date of purchase.\n\n## Conditions for Return\n${(d.conditions || '').split('\n').filter(Boolean).map(c => `- ${c.trim()}`).join('\n')}\n\n## Refund Method\n${d.method || 'Original payment method'}\n\n## Return Process\n${(d.steps || '').split('\n').filter(Boolean).map((s, i) => `${i + 1}. ${s.trim()}`).join('\n')}\n\n## Instructions\n- Always ask for the order number first.\n- Verify the return is within the return window.\n- Be empathetic ‚Äî never argue with the customer.\n- If a return is not eligible, explain clearly and offer alternatives.`
      },
      upsell_crosssell: {
        title: 'Upsell & Cross-sell',
        icon: 'üí∞',
        desc: 'Teach the AI when and how to recommend additional products.',
        fields: [
          { key: 'pairs', label: 'Product Pairs / Combos (one per line, format: "When X ‚Üí Suggest Y")', placeholder: 'When Laptop ‚Üí Suggest Laptop Bag\nWhen Phone ‚Üí Suggest Screen Protector', type: 'textarea' },
          { key: 'discounts', label: 'Bundle Discounts / Rules', placeholder: 'e.g. Buy 2 Get 10% off, Free shipping over $50', type: 'textarea' },
          { key: 'triggers', label: 'Trigger Phrases (one per line)', placeholder: 'anything else?\ndo you have accessories?\nwhat goes well with this?', type: 'textarea' }
        ],
        generate: (d) => `# Upsell & Cross-sell Skill\n\n## Product Recommendations\n${(d.pairs || '').split('\n').filter(Boolean).map(p => `- ${p.trim()}`).join('\n')}\n\n## Bundle Discounts & Offers\n${(d.discounts || '').split('\n').filter(Boolean).map(p => `- ${p.trim()}`).join('\n')}\n\n## Trigger Phrases\nWhen the customer says any of these, suggest related products:\n${(d.triggers || '').split('\n').filter(Boolean).map(p => `- "${p.trim()}"`).join('\n')}\n\n## Instructions\n- Only suggest products from the catalog.\n- Keep suggestions natural ‚Äî don't be pushy.\n- Mention discounts or bundles when applicable.\n- Maximum 2 suggestions per interaction.`
      },
      faq: {
        title: 'FAQ Base',
        icon: '‚ùì',
        desc: 'Add common questions and answers for the AI to use.',
        fields: [],
        isFaq: true,
        generate: (d) => {
          const pairs = d.faqPairs || [];
          if (pairs.length === 0) return '# Frequently Asked Questions\n\nNo questions added yet.';
          return `# Frequently Asked Questions\n\n${pairs.map((p, i) => `## ${i + 1}. ${p.q}\n${p.a}`).join('\n\n')}`;
        }
      }
    };

    let currentTemplateKey = null;

    function openTemplatePicker() {
      // Check limits first
      const roleLimits = { 'FREE': 3, 'PREMIUM': 10, 'ENTERPRISE': 20, 'ADMIN': 99999 };
      const userRole = me?.role || 'FREE';
      const limit = roleLimits[userRole] || 1;
      if (kbOptions.length >= limit) {
        alert(`Your current tier (${userRole}) is limited to ${limit} Knowledge Base item(s). Please upgrade to add more.`);
        return;
      }
      document.getElementById('templatePickerModal').style.display = 'flex';
    }

    function selectTemplate(key) {
      closeModal('templatePickerModal');
      if (key === 'blank') {
        openKbModal();
        return;
      }
      currentTemplateKey = key;
      const tpl = SKILL_TEMPLATES[key];
      if (!tpl) return;

      document.getElementById('templateFormTitle').innerText = `${tpl.icon} ${tpl.title}`;
      document.getElementById('templateFormDesc').innerText = tpl.desc;

      const container = document.getElementById('templateFormFields');

      // Language selector for templates that support it
      let langHtml = '';
      if (tpl.hasLang) {
        langHtml = `
          <div style="background:var(--bg); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:24px; display:flex; align-items:center; gap:16px">
            <div style="display:flex; align-items:center; gap:8px; flex-shrink:0">
              <span style="font-size:1.2rem">üåê</span>
              <label style="margin:0; font-weight:700; font-size:0.85rem; white-space:nowrap">Language / Wika</label>
            </div>
            <select id="template-lang-select" class="input" style="margin:0; flex:1">
              <option value="english">üá∫üá∏ English</option>
              <option value="tagalog">üáµüá≠ Tagalog</option>
            </select>
          </div>
        `;
      }

      if (tpl.isFaq) {
        container.innerHTML = `
          ${langHtml}
          <div id="faq-pairs-container"></div>
          <button type="button" class="btn btn-secondary" style="margin-top:12px" onclick="addFaqPair()">+ Add Question</button>
        `;
        // Start with 2 empty pairs
        addFaqPair();
        addFaqPair();
      } else {
        container.innerHTML = langHtml + tpl.fields.map(f => {
          if (f.type === 'textarea') {
            return `<label>${escapeHtml(f.label)}</label><textarea class="input" data-key="${f.key}" placeholder="${escapeHtml(f.placeholder)}" style="min-height:100px"></textarea>`;
          }
          return `<label>${escapeHtml(f.label)}</label><input class="input" data-key="${f.key}" placeholder="${escapeHtml(f.placeholder)}">`;
        }).join('');
      }

      document.getElementById('templateFormModal').style.display = 'flex';
    }

    function addFaqPair() {
      const container = document.getElementById('faq-pairs-container');
      const idx = container.children.length;
      const pair = document.createElement('div');
      pair.style.cssText = 'background:var(--bg); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:12px; position:relative;';
      pair.innerHTML = `
        <button type="button" onclick="this.parentElement.remove()" style="position:absolute; top:8px; right:12px; background:none; border:none; color:var(--text-dim); cursor:pointer; font-size:1.1rem;">&times;</button>
        <label style="font-size:0.75rem">Question ${idx + 1}</label>
        <input class="input faq-q" placeholder="e.g. What are your shipping options?" style="margin-bottom:8px">
        <label style="font-size:0.75rem">Answer</label>
        <textarea class="input faq-a" placeholder="We offer standard (3-5 days) and express (1 day) shipping..." style="min-height:70px"></textarea>
      `;
      container.appendChild(pair);
    }

    async function saveTemplateForm() {
      const tpl = SKILL_TEMPLATES[currentTemplateKey];
      if (!tpl) return;

      let data = {};
      if (tpl.isFaq) {
        const qs = document.querySelectorAll('#faq-pairs-container .faq-q');
        const as = document.querySelectorAll('#faq-pairs-container .faq-a');
        const pairs = [];
        qs.forEach((q, i) => {
          const qv = q.value.trim();
          const av = as[i]?.value.trim();
          if (qv && av) pairs.push({ q: qv, a: av });
        });
        if (pairs.length === 0) {
          alert('Please add at least one question and answer.');
          return;
        }
        data.faqPairs = pairs;
      } else {
        document.querySelectorAll('#templateFormFields [data-key]').forEach(el => {
          data[el.dataset.key] = el.value;
        });
      }

      // Read the language selection if present
      const langSelect = document.getElementById('template-lang-select');
      if (langSelect) {
        data.lang = langSelect.value;
      }

      const title = tpl.title;
      const content = tpl.generate(data);

      closeModal('templateFormModal');

      // Save via API
      try {
        const res = await fetch('/api/knowledge', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentSession.access_token}`
          },
          body: JSON.stringify({ title, content })
        });
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to save.');
        }
        kbLoaded = false;
        await loadKbOptions();
        renderKbListBase();
      } catch (err) {
        alert('Error saving skill: ' + err.message);
      }
    }

    // ==================== ADD TO PAGE ====================

    async function toggleAddToPage(kbId, kbTitle) {
      const popup = document.getElementById('atp-popup-' + kbId);
      if (!popup) return;

      // Toggle visibility
      if (popup.classList.contains('active')) {
        popup.classList.remove('active');
        return;
      }

      // Close all other popups
      document.querySelectorAll('.atp-popup.active').forEach(p => p.classList.remove('active'));

      // Load pages if needed
      if (!pagesLoaded || pagesCache.length === 0) {
        try {
          const res = await fetch('/api/pages', { headers: { 'Authorization': `Bearer ${currentSession.access_token}` } });
          pagesCache = await res.json();
          pagesLoaded = true;
        } catch (e) {
          popup.innerHTML = '<div style="padding:12px; font-size:0.8rem; color:var(--danger)">Failed to load pages</div>';
          popup.classList.add('active');
          return;
        }
      }

      if (pagesCache.length === 0) {
        popup.innerHTML = '<div style="padding:12px; font-size:0.8rem; color:var(--text-dim)">No automations found. Create one first.</div>';
        popup.classList.add('active');
        return;
      }

      popup.innerHTML = `
        <div class="atp-title">Link "${escapeHtml(kbTitle)}" to:</div>
        ${pagesCache.map(p => {
        const isLinked = Array.isArray(p.knowledge_base) && p.knowledge_base.includes(kbTitle);
        return `<label class="atp-item">
            <input type="checkbox" ${isLinked ? 'checked' : ''} onchange="toggleSkillOnPage('${p.id}', '${escapeHtml(kbTitle).replace(/'/g, "\\'").replace(/"/g, '&quot;')}', this.checked)">
            <span>${escapeHtml(p.name)}</span>
          </label>`;
      }).join('')}
      `;
      popup.classList.add('active');
    }

    async function toggleSkillOnPage(pageId, kbTitle, add) {
      const page = pagesCache.find(p => p.id === pageId);
      if (!page) return;

      let kb = Array.isArray(page.knowledge_base) ? [...page.knowledge_base] : [];
      if (add && !kb.includes(kbTitle)) {
        kb.push(kbTitle);
      } else if (!add) {
        kb = kb.filter(k => k !== kbTitle);
      }

      try {
        const res = await fetch('/api/pages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentSession.access_token}`
          },
          body: JSON.stringify({
            id: pageId,
            name: page.name,
            fb_page_id: page.fb_page_id,
            knowledge_base: kb
          })
        });
        if (!res.ok) throw new Error('Failed to update page');

        // Update local cache
        const idx = pagesCache.findIndex(p => p.id === pageId);
        if (idx > -1) pagesCache[idx].knowledge_base = kb;

      } catch (e) {
        alert('Error updating page: ' + e.message);
      }
    }

    // Close add-to-page popups when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.atp-popup') && !e.target.closest('[onclick*="toggleAddToPage"]')) {
        document.querySelectorAll('.atp-popup.active').forEach(p => p.classList.remove('active'));
      }
    });

    function openKbModal(id = null) {
      document.getElementById('kbModalTitle').innerText = id ? 'Refine Skill' : 'Create New Skill';
      document.getElementById('kb-id-hidden').value = id || '';
      document.getElementById('kb-title').value = '';
      document.getElementById('kb-content').value = '';
      const titleInput = document.getElementById('kb-title');
      titleInput.readOnly = false;
      titleInput.style.opacity = '1';
      titleInput.style.cursor = 'text';
      if (id) {
        const k = kbOptions.find(k => k.id === id);
        if (k) {
          document.getElementById('kb-title').value = k.title;
          document.getElementById('kb-content').value = k.content;
          // Lock title for PERSONALITY skill
          if (k.title === 'PERSONALITY') {
            document.getElementById('kbModalTitle').innerText = 'üß† Edit Chatbot Personality';
            titleInput.readOnly = true;
            titleInput.style.opacity = '0.6';
            titleInput.style.cursor = 'not-allowed';
          }
        }
      }
      document.getElementById('kbModal').style.display = 'flex';
    }

    async function saveKb() {
      const isNew = !document.getElementById('kb-id-hidden').value;

      if (isNew) {
        // Enforce limits on the frontend before saving
        const roleLimits = {
          'FREE': 3,
          'PREMIUM': 10,
          'ENTERPRISE': 20,
          'ADMIN': 99999
        };
        const userRole = me?.role || 'FREE';
        const limit = roleLimits[userRole] || 1;

        if (kbOptions.length >= limit) {
          alert(`Your current tier (${userRole}) is limited to ${limit} Knowledge Base item(s). Please upgrade to add more.`);
          return;
        }
      }

      const body = {
        id: document.getElementById('kb-id-hidden').value || undefined,
        title: document.getElementById('kb-title').value,
        content: document.getElementById('kb-content').value
      };

      closeModal('kbModal');

      // Optimistic update
      let backupKbOptions = [...kbOptions];
      if (body.id) {
        const idx = kbOptions.findIndex(k => k.id === body.id);
        if (idx > -1) kbOptions[idx] = { ...kbOptions[idx], ...body };
      } else {
        kbOptions.unshift({ ...body, id: 'temp-' + Date.now() });
      }
      kbLoaded = false;
      renderKbListBase();

      try {
        const res = await fetch('/api/knowledge', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentSession.access_token}`
          },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const errData = await res.json();
          throw new Error(errData.error || 'Failed to save knowledge base item.');
        }
        await loadKb();
      } catch (err) {
        alert(err.message);
        // Rollback optimistic update on error
        kbOptions = backupKbOptions;
        renderKbListBase();
      }
    }

    async function updatePassword() {
      const password = document.getElementById('new-password').value;
      if (password.length < 8) { alert('Password must be at least 8 characters.'); return; }
      const { error } = await sb.auth.updateUser({ password });
      if (error) alert(error.message);
      else { alert('Password updated!'); document.getElementById('new-password').value = ''; }
    }

    async function updatePin() {
      const pin = document.getElementById('new-pin').value;
      if (pin.length < 6) { alert('PIN must be 6 digits.'); return; }
      const res = await fetch('/api/me/pin', { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentSession.access_token}` }, body: JSON.stringify({ pin }) });
      if (res.ok) { alert('PIN updated!'); document.getElementById('new-pin').value = ''; }
    }

    function editUser(id, credits, role, email) {
      document.getElementById('admin-um-id').value = id;
      document.getElementById('admin-um-email').innerText = email;
      document.getElementById('admin-um-credits').value = credits;
      document.getElementById('admin-um-role').value = role;
      document.getElementById('adminUserModal').style.display = 'flex';
    }

    async function saveAdminUser() {
      const id = document.getElementById('admin-um-id').value;
      const credits = parseInt(document.getElementById('admin-um-credits').value);
      const role = document.getElementById('admin-um-role').value;

      const btn = document.querySelector('#adminUserModal button[type="submit"]');
      const originalText = btn.innerText;
      btn.innerText = 'Saving...';
      btn.disabled = true;

      try {
        const res = await fetch('/api/admin/users/' + id, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentSession.access_token}` },
          body: JSON.stringify({ credits: credits, role: role })
        });

        if (!res.ok) throw new Error('Failed to update');
        closeModal('adminUserModal');
        loadAdminUsers();
      } catch (e) {
        alert('Failed to update user: ' + e.message);
      } finally {
        btn.innerText = originalText;
        btn.disabled = false;
      }
    }

    async function deletePage(id) {
      if (confirm('Delete automation?')) {
        pagesCache = pagesCache.filter(p => p.id !== id);
        renderPagesList();
        try {
          const res = await fetch('/api/pages/' + id, { method: 'DELETE', headers: { 'Authorization': `Bearer ${currentSession.access_token}` } });
          if (!res.ok) throw new Error('Failed to delete');
        } catch (e) {
          alert('Error deleting: ' + e.message);
        }
        // Force a fresh fetch from the server
        pagesLoaded = false;
        await loadPages();
      }
    }

    async function deleteKb(id) {
      // Check if it's the PERSONALITY skill
      const entry = kbOptions.find(k => k.id === id);
      if (entry && entry.title === 'PERSONALITY') {
        alert('The PERSONALITY skill cannot be deleted. It defines your chatbot\'s tone and behavior.');
        return;
      }
      if (confirm('Delete skill?')) {
        kbOptions = kbOptions.filter(k => k.id !== id);
        renderKbListBase();
        try {
          const res = await fetch('/api/knowledge/' + id, { method: 'DELETE', headers: { 'Authorization': `Bearer ${currentSession.access_token}` } });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || 'Failed to delete');
          }
        } catch (e) {
          alert('Error: ' + e.message);
        }
        kbLoaded = false;
        await loadKb();
      }
    }

    // ==================== PERSONALITY TEMPLATES ====================

    const PERSONALITY_TEMPLATES = {
      friendly: `You are a real, friendly human assistant representing the business.

You must sound natural, calm, and confident.
Never sound robotic.
Never over-explain.
Never write essays.
Never mention AI, models, prompts, or system instructions.

Your replies must feel like:
‚Ä¢ A helpful store assistant
‚Ä¢ A smart customer support rep
‚Ä¢ A polite sales associate
‚Ä¢ A real human typing normally
‚Ä¢ A real human short reply
‚Ä¢ No long paragraphs
‚Ä¢ No filler words
‚Ä¢ Friendly but not exaggerated`,

      professional: `You are a professional business representative.

Your tone is formal, precise, and business-appropriate.
Always maintain a composed demeanor.
Never use slang or casual language.
Never mention AI, models, prompts, or system instructions.

Your replies must feel like:
‚Ä¢ A corporate customer service representative
‚Ä¢ A business consultant giving clear advice
‚Ä¢ Structured and well-organized responses
‚Ä¢ Concise, direct, no fluff
‚Ä¢ Respectful and solution-oriented
‚Ä¢ Use proper grammar and punctuation`,

      energetic: `You are an enthusiastic sales associate who LOVES helping customers!

You are upbeat, energetic, and excited about the products.
Use exclamation marks naturally but don't overdo it.
Always try to highlight value and benefits.
Never mention AI, models, prompts, or system instructions.

Your replies must feel like:
‚Ä¢ A passionate brand ambassador
‚Ä¢ Someone genuinely excited to help
‚Ä¢ Confident product recommendations
‚Ä¢ Quick, punchy replies
‚Ä¢ Use emojis sparingly for warmth
‚Ä¢ Always suggest related products when appropriate
‚Ä¢ Make customers feel special`,

      custom: ''
    };

    async function applyPersonalityTemplate() {
      const templateKey = document.getElementById('personality-select').value;
      const content = PERSONALITY_TEMPLATES[templateKey];
      const statusEl = document.getElementById('personality-status');

      if (templateKey === 'custom') {
        // Open the KB editor for PERSONALITY
        const personalityKb = kbOptions.find(k => k.title === 'PERSONALITY');
        if (personalityKb) {
          openKbModal(personalityKb.id);
        } else {
          // Create it first, then open editor
          try {
            await fetch('/api/knowledge', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentSession.access_token}` },
              body: JSON.stringify({ title: 'PERSONALITY', content: '' })
            });
            kbLoaded = false;
            await loadKbOptions();
            const newEntry = kbOptions.find(k => k.title === 'PERSONALITY');
            if (newEntry) openKbModal(newEntry.id);
          } catch (e) {
            alert('Error creating personality: ' + e.message);
          }
        }
        return;
      }

      // Find the PERSONALITY KB entry or create it via API
      let personalityKb = kbOptions.find(k => k.title === 'PERSONALITY');

      try {
        if (personalityKb) {
          // Update existing
          const res = await fetch('/api/knowledge', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentSession.access_token}` },
            body: JSON.stringify({ id: personalityKb.id, title: 'PERSONALITY', content })
          });
          if (!res.ok) throw new Error('Failed to update personality');
          personalityKb.content = content;
        } else {
          // Create new
          const res = await fetch('/api/knowledge', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentSession.access_token}` },
            body: JSON.stringify({ title: 'PERSONALITY', content })
          });
          if (!res.ok) throw new Error('Failed to create personality');
          // Refresh KB cache
          kbLoaded = false;
          await loadKbOptions();
        }

        const labels = { friendly: 'ü§ù Friendly Assistant', professional: 'üéØ Professional', energetic: 'üéâ Energetic Seller' };
        statusEl.innerText = `‚úì Personality set to: ${labels[templateKey]}`;
        statusEl.style.display = 'block';
      } catch (e) {
        alert('Error setting personality: ' + e.message);
      }
    }
    function closeModal(m) { document.getElementById(m).style.display = 'none'; }
    async function logout() { await sb.auth.signOut(); window.location.href = '/login'; }

    // ==================== ADMIN LOGS ====================
    let adminLogsCache = [];
    let adminLogsSubscription = null;

    async function loadAdminLogs() {
      try {
        const [logsRes, pagesRes] = await Promise.all([
          fetch('/api/admin/logs', { headers: { 'Authorization': `Bearer ${currentSession.access_token}` } }),
          fetch('/api/admin/pages', { headers: { 'Authorization': `Bearer ${currentSession.access_token}` } })
        ]);
        const logs = await logsRes.json();
        const pages = await pagesRes.json();
        if (logsRes.ok) { adminLogsCache = logs; renderAdminLogs(); }
        if (pagesRes.ok) renderAdminPages(pages);
      } catch (e) { console.error('Admin logs error:', e); }
    }

    function renderAdminPages(pages) {
      const tbody = document.getElementById('admin-pages-table');
      if (!pages || pages.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No pages found.</td></tr>';
        return;
      }
      tbody.innerHTML = pages.map(p => `
        <tr>
          <td style="font-weight:600">${escapeHtml(p.name)}</td>
          <td>
            <div style="font-size:0.85rem">${escapeHtml(p.profiles?.email || 'Unknown')}</div>
            <div style="font-size:0.7rem; color:var(--text-dim)">${p.profiles?.role || '-'}</div>
          </td>
          <td style="font-size:0.8rem; font-family:monospace; color:var(--text-muted)">${escapeHtml(p.ai_model || 'default')}</td>
          <td>
            <span class="badge ${p.is_enabled ? 'badge-premium' : 'badge-free'}" style="font-size:0.7rem">${p.is_enabled ? '‚óè Active' : '‚óã Disabled'}</span>
          </td>
          <td style="font-weight:600">${p.profiles?.credits ?? '-'}</td>
        </tr>
      `).join('');
    }

    function renderAdminLogs(highlight) {
      const tbody = document.getElementById('admin-logs-table');
      document.getElementById('admin-log-count').innerText = `${adminLogsCache.length} events`;
      if (!adminLogsCache || adminLogsCache.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No activity logs yet.</td></tr>';
        return;
      }
      tbody.innerHTML = adminLogsCache.map((l, i) => {
        const isNew = highlight && i === 0;
        return `
          <tr class="${isNew ? 'admin-log-new' : ''}">
            <td style="color:var(--text-dim); white-space:nowrap; font-size:0.8rem">${new Date(l.created_at).toLocaleString()}</td>
            <td style="font-weight:600; font-size:0.85rem">${escapeHtml(l.fb_pages?.name || '---')}</td>
            <td>
              <div style="font-size:0.8rem">${escapeHtml(l.fb_pages?.profiles?.email || '---')}</div>
              <div style="font-size:0.65rem; color:var(--text-dim)">${escapeHtml(l.fb_pages?.profiles?.role || '')}</div>
            </td>
            <td><span class="badge ${l.type === 'AUTO_REPLY' ? 'badge-premium' : 'badge-free'}" style="font-size:0.65rem">${l.type}</span></td>
            <td style="max-width:500px; font-size:0.8rem; line-height:1.4">
              ${l.payload ? `
                ${l.payload.sender ? `<div style="font-size:0.65rem; color:var(--primary); font-family:monospace; margin-bottom:2px">Sender: ${escapeHtml(l.payload.sender)}</div>` : ''}
                ${l.payload.in ? `<div style="margin-bottom:2px"><strong>User:</strong> <span style="color:var(--text-dim)">${escapeHtml(l.payload.in.substring(0, 120))}${l.payload.in.length > 120 ? '...' : ''}</span></div>` : ''}
                ${l.payload.out ? `<div><strong>AI:</strong> <span style="color:var(--text)">${escapeHtml(l.payload.out.substring(0, 120))}${l.payload.out.length > 120 ? '...' : ''}</span></div>` : ''}
              ` : 'No payload'}
            </td>
          </tr>
        `;
      }).join('');
    }

    function startAdminLogsSubscription() {
      if (adminLogsSubscription) return;
      adminLogsSubscription = sb.channel('admin-activity-logs')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'activity_logs' }, async (payload) => {
          // Re-fetch to get joined data
          await loadAdminLogs();
          renderAdminLogs(true);
        })
        .subscribe();
    }

    // Handle mobile sidebar toggle
    function toggleSidebar() {
      const sidebar = document.querySelector('.sidebar');
      sidebar.classList.toggle('open');
    }

    // Close sidebar if user clicks outside of it on mobile
    document.addEventListener('click', (e) => {
      const sidebar = document.querySelector('.sidebar');
      const hamburger = document.querySelector('.hamburger');
      if (window.innerWidth <= 900 && sidebar.classList.contains('open') && !sidebar.contains(e.target) && !hamburger.contains(e.target)) {
        sidebar.classList.remove('open');
      }
    });

    // ==================== IMAGES & TRIGGER PHOTOS JS ====================
    let imagesCache = [];
    let triggerPhotosCache = [];
    let pendingUploadFile = null;

    async function loadImages() {
      const gallery = document.getElementById('images-gallery');
      gallery.innerHTML = '<div class="empty-state"><h3>Loading Images...</h3><p style="opacity:0.6; margin-top:8px">Fetching your uploaded images...</p></div>';
      try {
        const [imgRes, tpRes] = await Promise.all([
          fetch('/api/images', { headers: { 'Authorization': `Bearer ${currentSession.access_token}` } }),
          fetch('/api/trigger-photos', { headers: { 'Authorization': `Bearer ${currentSession.access_token}` } })
        ]);
        const imgData = await imgRes.json();
        imagesCache = imgData.images || [];
        const role = me?.role || 'FREE';
        const limits = { FREE: 3, PREMIUM: 50, ENTERPRISE: '‚àû', ADMIN: '‚àû' };
        document.getElementById('img-usage-badge').innerText = `${imgData.used || 0} / ${limits[role] || 3} images`;
        triggerPhotosCache = await tpRes.json();
      } catch (e) {
        imagesCache = [];
        triggerPhotosCache = [];
        console.error('Failed to load images:', e);
      }
      renderImagesGallery();
      renderTriggerPhotosList();
    }

    function renderImagesGallery() {
      const gallery = document.getElementById('images-gallery');
      if (imagesCache.length === 0) {
        gallery.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><h3>No Images Yet</h3><p>Upload your first image to get started.</p></div>';
        return;
      }
      gallery.innerHTML = imagesCache.map(img => `
        <div class="card" style="padding:0; overflow:hidden; margin-bottom:0">
          <div style="width:100%; height:140px; background:var(--bg); display:flex; align-items:center; justify-content:center; overflow:hidden">
            <img src="${escapeHtml(img.file_url)}" alt="${escapeHtml(img.file_name)}" style="width:100%; height:100%; object-fit:cover" loading="lazy">
          </div>
          <div style="padding:12px">
            <div style="font-size:0.8rem; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis" title="${escapeHtml(img.file_name)}">${escapeHtml(img.file_name)}</div>
            <div style="font-size:0.7rem; color:var(--text-dim); margin-top:4px">${(img.file_size / 1024).toFixed(1)} KB ¬∑ ${new Date(img.created_at).toLocaleDateString()}</div>
            <div style="display:flex; gap:6px; margin-top:10px">
              <button class="btn btn-secondary" style="flex:1; padding:6px; font-size:0.7rem" onclick="copyText('${escapeHtml(img.file_url)}', this)">Copy URL</button>
              <button class="btn btn-danger" style="padding:6px 10px; font-size:0.7rem" onclick="deleteImage('${img.id}')">Del</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderTriggerPhotosList() {
      const list = document.getElementById('trigger-photos-list');
      if (triggerPhotosCache.length === 0) {
        list.innerHTML = '<div class="card" style="text-align:center; padding:32px"><p style="color:var(--text-dim)">No trigger photos configured yet.</p></div>';
        return;
      }
      list.innerHTML = triggerPhotosCache.map(tp => {
        const img = tp.user_images;
        return `
        <div class="card" style="margin-bottom:12px">
          <div style="display:flex; gap:16px; align-items:flex-start">
            <div style="width:72px; height:72px; border-radius:10px; overflow:hidden; flex-shrink:0; background:var(--bg); border:1px solid var(--border)">
              ${img ? `<img src="${escapeHtml(img.file_url)}" style="width:100%; height:100%; object-fit:cover" alt="">` : '<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:0.7rem;color:var(--text-dim)">No img</div>'}
            </div>
            <div style="flex:1; min-width:0">
              <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px">
                <div>
                  <div style="font-weight:700; font-size:0.95rem; margin-bottom:4px">Trigger Photo</div>
                  <div style="display:flex; flex-wrap:wrap; gap:4px; margin-bottom:8px">
                    ${tp.trigger_words.split(',').map(w => `<span class="badge badge-free" style="font-size:0.65rem">${escapeHtml(w.trim())}</span>`).join('')}
                  </div>
                </div>
                <div style="display:flex; gap:6px; flex-shrink:0">
                  <button class="btn btn-secondary" style="padding:4px 10px; font-size:0.75rem" onclick="openTriggerPhotoModal('${tp.id}')">Edit</button>
                  <button class="btn btn-danger" style="padding:4px 10px; font-size:0.75rem" onclick="deleteTriggerPhoto('${tp.id}')">Del</button>
                </div>
              </div>
              <div style="display:flex; gap:12px; font-size:0.75rem; color:var(--text-dim)">
                ${tp.auto_send_enabled ? `<span style="color:var(--success)">‚ö° Auto-send after ${tp.auto_send_threshold || 10} msgs</span>` : '<span>Manual trigger only</span>'}
                ${tp.is_kb_skill ? '<span style="color:#c084fc">üß† KB Skill</span>' : ''}
              </div>
            </div>
          </div>
        </div>
        `;
      }).join('');
    }

    // Upload modal helpers
    function openUploadModal() {
      resetUploadModal();
      document.getElementById('uploadImageModal').style.display = 'flex';
    }

    function resetUploadModal() {
      pendingUploadFile = null;
      document.getElementById('upload-preview').style.display = 'none';
      document.getElementById('upload-placeholder').style.display = 'block';
      document.getElementById('upload-submit-btn').disabled = true;
      document.getElementById('upload-file-input').value = '';
    }

    function handleUploadDrop(e) {
      const file = e.dataTransfer.files[0];
      if (file) setUploadFile(file);
    }

    function handleUploadSelect(e) {
      const file = e.target.files[0];
      if (file) setUploadFile(file);
    }

    function setUploadFile(file) {
      const allowed = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
      if (!allowed.includes(file.type)) { alert('Invalid file type. Only JPEG, PNG, GIF, and WebP are allowed.'); return; }
      if (file.size > 5 * 1024 * 1024) { alert('File too large. Maximum size is 5MB.'); return; }
      pendingUploadFile = file;
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('upload-preview-img').src = e.target.result;
        document.getElementById('upload-preview').style.display = 'block';
        document.getElementById('upload-placeholder').style.display = 'none';
        document.getElementById('upload-submit-btn').disabled = false;
      };
      reader.readAsDataURL(file);
    }

    async function submitUpload() {
      if (!pendingUploadFile) return;
      const btn = document.getElementById('upload-submit-btn');
      btn.disabled = true;
      btn.innerText = 'Uploading...';

      try {
        const fd = new FormData();
        fd.append('image', pendingUploadFile);
        const res = await fetch('/api/images/upload', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${currentSession.access_token}` },
          body: fd
        });
        const result = await res.json();
        if (!res.ok) { alert(result.error || 'Upload failed.'); return; }
        closeModal('uploadImageModal');
        resetUploadModal();
        await loadImages();
      } catch (e) {
        alert('Upload error: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.innerText = 'Upload Image';
      }
    }

    async function deleteImage(id) {
      if (!confirm('Delete this image? Any linked trigger photos will also be removed.')) return;
      try {
        const res = await fetch('/api/images/' + id, { method: 'DELETE', headers: { 'Authorization': `Bearer ${currentSession.access_token}` } });
        if (!res.ok) { const err = await res.json(); throw new Error(err.error || 'Failed to delete'); }
      } catch (e) { alert('Error: ' + e.message); }
      await loadImages();
    }

    // Trigger Photo modal helpers
    function openTriggerPhotoModal(editId) {
      document.getElementById('tp-id-hidden').value = '';
      document.getElementById('tp-trigger-words').value = '';
      document.getElementById('tp-auto-send').checked = false;
      document.getElementById('tp-threshold-row').style.display = 'none';
      document.getElementById('tp-threshold').value = '10';
      document.getElementById('tp-kb-skill').checked = false;
      document.getElementById('tp-image-preview').innerHTML = '<span style="font-size:0.7rem; color:var(--text-dim)">Preview</span>';
      document.getElementById('triggerPhotoModalTitle').innerText = 'Create Trigger Photo';

      // Populate image selector
      const select = document.getElementById('tp-image-select');
      select.innerHTML = '<option value="">-- Choose an uploaded image --</option>' +
        imagesCache.map(img => `<option value="${img.id}" data-url="${escapeHtml(img.file_url)}">${escapeHtml(img.file_name)}</option>`).join('');

      if (editId) {
        const tp = triggerPhotosCache.find(t => t.id === editId);
        if (tp) {
          document.getElementById('tp-id-hidden').value = tp.id;
          document.getElementById('tp-trigger-words').value = tp.trigger_words;
          document.getElementById('tp-auto-send').checked = !!tp.auto_send_enabled;
          document.getElementById('tp-threshold-row').style.display = tp.auto_send_enabled ? 'flex' : 'none';
          document.getElementById('tp-threshold').value = tp.auto_send_threshold || '10';
          document.getElementById('tp-kb-skill').checked = !!tp.is_kb_skill;
          document.getElementById('triggerPhotoModalTitle').innerText = 'Edit Trigger Photo';
          select.value = tp.image_id;
          previewTriggerImage();
        }
      }

      document.getElementById('triggerPhotoModal').style.display = 'flex';
    }

    function previewTriggerImage() {
      const select = document.getElementById('tp-image-select');
      const option = select.options[select.selectedIndex];
      const url = option?.getAttribute('data-url');
      const preview = document.getElementById('tp-image-preview');
      if (url) {
        preview.innerHTML = `<img src="${url}" style="width:100%; height:100%; object-fit:cover" alt="">`;
      } else {
        preview.innerHTML = '<span style="font-size:0.7rem; color:var(--text-dim)">Preview</span>';
      }
    }

    async function saveTriggerPhoto() {
      const imageId = document.getElementById('tp-image-select').value;
      const triggerWords = document.getElementById('tp-trigger-words').value.trim();
      if (!imageId) { alert('Please select an image.'); return; }
      if (!triggerWords) { alert('Please enter at least one trigger word or phrase.'); return; }

      const body = {
        id: document.getElementById('tp-id-hidden').value || undefined,
        image_id: imageId,
        trigger_words: triggerWords,
        auto_send_enabled: document.getElementById('tp-auto-send').checked,
        auto_send_threshold: parseInt(document.getElementById('tp-threshold').value) || 10,
        is_kb_skill: document.getElementById('tp-kb-skill').checked
      };

      try {
        const res = await fetch('/api/trigger-photos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentSession.access_token}` },
          body: JSON.stringify(body)
        });
        const result = await res.json();
        if (!res.ok) { alert(result.error || 'Failed to save.'); return; }
        closeModal('triggerPhotoModal');
        await loadImages();
      } catch (e) { alert('Error: ' + e.message); }
    }

    async function deleteTriggerPhoto(id) {
      if (!confirm('Delete this trigger photo?')) return;
      try {
        const res = await fetch('/api/trigger-photos/' + id, { method: 'DELETE', headers: { 'Authorization': `Bearer ${currentSession.access_token}` } });
        if (!res.ok) { const err = await res.json(); throw new Error(err.error || 'Failed to delete'); }
      } catch (e) { alert('Error: ' + e.message); }
      await loadImages();
    }

    init();
  </script>
</body>

</html>